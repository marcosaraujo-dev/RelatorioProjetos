{% extends "base.html" %}

{% block title %}Relat√≥rio de MANs - Sistema de Projetos{% endblock %}
{% block mans_active %}active{% endblock %}
{% block page_title %}<i class="fas fa-wrench me-2"></i> Relat√≥rio de MANs (Manuten√ß√µes){% endblock %}

{% block filtros_display %}display: none;{% endblock %}

{% block head %}
<style>
/* Estilos espec√≠ficos para manter o grid da tabela consistente */
#tableMans {
    table-layout: fixed;
    width: 100%;
}

#tableMans th,
#tableMans td {
    word-wrap: break-word;
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
}

/* Larguras espec√≠ficas das colunas para manter consist√™ncia */
#tableMans th:nth-child(1), #tableMans td:nth-child(1) { width: 10%; }
#tableMans th:nth-child(2), #tableMans td:nth-child(2) { width: 25%; }
#tableMans th:nth-child(3), #tableMans td:nth-child(3) { width: 12%; }
#tableMans th:nth-child(4), #tableMans td:nth-child(4) { width: 10%; }
#tableMans th:nth-child(5), #tableMans td:nth-child(5) { width: 10%; }
#tableMans th:nth-child(6), #tableMans td:nth-child(6) { width: 10%; }
#tableMans th:nth-child(7), #tableMans td:nth-child(7) { width: 8%; }
#tableMans th:nth-child(8), #tableMans td:nth-child(8) { width: 8%; }
#tableMans th:nth-child(9), #tableMans td:nth-child(9) { width: 7%; }


/* Modal de detalhes */
#modalDetalheMAN .modal-body {
    max-height: 80vh !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    padding-right: 15px !important;
}

#modalDetalheMAN .modal-dialog {
    max-height: 95vh !important;
    margin: 1rem auto !important;
}

#modalDetalheMAN .modal-content {
    max-height: 90vh !important;
    display: flex !important;
    flex-direction: column !important;
}

@media (max-width: 768px) {
    #modalDetalheMAN .modal-body {
        max-height: 70vh !important;
    }
    
    #modalDetalheMAN .modal-dialog {
        margin: 0.5rem !important;
    }
    
    #tableMans {
        table-layout: auto;
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}

{% block content %}

<!-- Filtros e Controles -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white justify-content-between align-items-center">
                <!-- Filtros Personalizados -->
                <div class="filtros-container" style="position: relative;">
                    <h6 class="mb-3 text-primary-custom">
                        <i class="fas fa-filter me-2"></i>
                        Filtros para MANs
                    </h6>
                    <div style="position: absolute; top: 10px; right: 20px; z-index: 10;">
                        <div class="d-flex align-items-end gap-2 h-100">
                            <div class="badge-contador">
                                <span id="totalRegistrosMans" class="badge-registros">0 MANs</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Per√≠odo de An√°lise -->
                    <div class="alert periodo-info py-2 mb-3 border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-calendar-alt me-2 text-primary"></i>
                            <strong>Per√≠odo de An√°lise:</strong>
                            <span id="periodo-texto-mans" class="ms-2 periodo-badge">Ano Atual</span>
                        </div>
                    </div>
                    
                    <!-- Filtros b√°sicos -->
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <label for="filterEquipeMans" class="form-label small fw-bold text-dark">
                                <i class="fas fa-users me-1 text-primary"></i>Equipe
                            </label>
                            <select id="filterEquipeMans" class="form-select form-select-sm modern-select">
                                <option value="">Todas as Equipes</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterStatusMans" class="form-label small fw-bold text-dark">
                                <i class="fas fa-flag me-1 text-success"></i>Status
                            </label>
                            <select id="filterStatusMans" class="form-select form-select-sm modern-select">
                                <option value="">Todos os Status</option>
                                <option value="AG. AN√ÅLISE">AG. AN√ÅLISE</option>
                                
                                <option value="Em An√°lise">Em An√°lise</option>
                                <option value="AN√ÅLISE CONCLU√çDA">AN√ÅLISE CONCLU√çDA</option>
                                
                                <option value="AG. DESENVOLVIMENTO">AG. DESENVOLVIMENTO</option>
                                <option value="Em Desenvolvimento">Em Desenvolvimento</option>
                                
                                <option value="AG. TESTES">AG. TESTES</option>
                                <option value="EM TESTES">EM TESTES</option>

                                <option value="AG. VALIDA√á√ÉO">AG. VALIDA√á√ÉO</option>
                                
                                <option value="Pre-release">Pre-release</option>
                                <option value="DONE">Done</option>
                                <option value="Closed">Closed</option>
                                <option value="Rejeitado">Rejeitado</option>
                                
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterProdutoMans" class="form-label small fw-bold text-dark">
                                <i class="fas fa-box me-1 text-info"></i>Produto
                            </label>
                            <select id="filterProdutoMans" class="form-select form-select-sm modern-select">
                                <option value="">Todos os Produtos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="searchMans" class="form-label small fw-bold text-dark">
                                <i class="fas fa-search me-1 text-warning"></i>Buscar
                            </label>
                            <input type="text" id="searchMans" class="form-control form-control-sm modern-input" placeholder="Buscar por n√∫mero ou resumo...">
                        </div>
                        
                    </div>
                    
                    <!-- Filtros de per√≠odo -->
                    <div class="row">
                        <div class="col-md-2">
                            <label for="filterPeriodoMans" class="form-label small fw-bold text-dark">
                                <i class="fas fa-clock me-1 text-info"></i>Per√≠odo
                            </label>
                            <select id="filterPeriodoMans" class="form-select form-select-sm modern-select">
                                <option value="ano_atual">Ano Atual</option>
                                <option value="q1">Q1 - Jan a Mar</option>
                                <option value="q2">Q2 - Abr a Jun</option>
                                <option value="q3">Q3 - Jul a Set</option>
                                <option value="q4">Q4 - Out a Dez</option>
                                <option value="6_meses">√öltimos 6 Meses</option>
                                <option value="3_meses">√öltimos 3 Meses</option>
                                <option value="mes_atual">M√™s Atual</option>
                                <option value="personalizado">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-md-3" id="datas-personalizadas-mans" style="display: none">
                            <div class="row">
                                <div class="col-6">
                                    <label for="filterDataInicioMans" class="form-label small fw-bold text-dark">Data In√≠cio</label>
                                    <input type="date" id="filterDataInicioMans" class="form-control form-control-sm modern-input">
                                </div>
                                <div class="col-6">
                                    <label for="filterDataFimMans" class="form-label small fw-bold text-dark">Data Fim</label>
                                    <input type="date" id="filterDataFimMans" class="form-control form-control-sm modern-input">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="d-flex align-items-end gap-2 h-100">
                                <div class="botoes-filtros">
                                    <button type="button" id="btnAplicarFiltrosMans" class="btn btn-primary btn-sm modern-btn">
                                        <i class="fas fa-search me-1"></i>
                                        APLICAR
                                    </button>
                                    <button type="button" id="btnLimparFiltrosMans" class="btn btn-outline-secondary btn-sm modern-btn">
                                        <i class="fas fa-times me-1"></i>
                                        LIMPAR
                                    </button>
                                  
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Grid de Relat√≥rio de MANs -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0 text-primary-custom">
                    <i class="fas fa-table me-2"></i>
                    Lista Detalhada de MANs
                </h5>
                <div class="d-flex gap-2">
                    <button id="btnExportCSVMans" class="btn btn-success btn-sm modern-btn">
                        <i class="fas fa-file-csv me-2"></i>
                        Exportar CSV
                    </button>
                    <button id="btnRefreshMans" class="btn btn-primary btn-sm modern-btn">
                        <i class="fas fa-sync-alt me-2"></i>
                        Atualizar
                    </button>
                </div>
            </div>
            <div class="card-body">
                
                <!-- Loading -->
                <div id="loadingMans" class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando dados das MANs...</p>
                </div>

                <!-- Erro -->
                <div id="errorMans" style="display: none;" class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessageMans"></span>
                </div>

                <!-- Tabela -->
                <div id="tableContainerMans" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tableMans">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="fas fa-hashtag me-1"></i>N√∫mero</th>
                                    <th><i class="fas fa-align-left me-1"></i>Resumo</th>
                                    <th><i class="fas fa-users me-1"></i>Equipe</th>
                                    <th><i class="fas fa-flag me-1"></i>Status</th>
                                    <th><i class="fas fa-box me-1"></i>Produto</th>
                                    <th><i class="fas fa-user me-1"></i>Respons√°vel</th>
                                    <th><i class="fas fa-calendar-plus me-1"></i>Cria√ß√£o</th>
                                    <th><i class="fas fa-calendar-check me-1"></i>Resolu√ß√£o</th>
                                    <th><i class="fas fa-cog me-1"></i>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyMans">
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagina√ß√£o -->
                    <nav aria-label="Pagina√ß√£o" class="mt-3">
                        <ul class="pagination justify-content-center" id="paginationMans">
                        </ul>
                    </nav>

                    <!-- Info da tabela -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <small class="text-muted">
                                Mostrando <span id="showingFromMans" class="fw-bold text-primary">0</span> a 
                                <span id="showingToMans" class="fw-bold text-primary">0</span> 
                                de <span id="totalRecordsMans" class="fw-bold text-primary">0</span> registros
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <label for="pageSizeMans" class="form-label me-2 small">Registros por p√°gina:</label>
                            <select id="pageSizeMans" class="form-select form-select-sm d-inline-block w-auto modern-select">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal Detalhes da MAN -->
<div class="modal fade" id="modalDetalheMAN" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-wrench me-2"></i>
                    Detalhes da MAN
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                
                <!-- Dados B√°sicos da MAN -->
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-primary fw-bold">
                            <i class="fas fa-info-circle me-1"></i>Dados B√°sicos da MAN
                        </h6>
                        <hr>
                        <div class="card border-primary mb-4">
                            <div class="row mb-4 p-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold text-primary">
                                            <i class="fas fa-hashtag me-1"></i>N√∫mero da MAN:
                                        </label>
                                        <p id="detalheNumeroMAN" class="form-control-plaintext border p-2 bg-light rounded"></p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold text-primary">
                                            <i class="fas fa-users me-1"></i>Equipe:
                                        </label>
                                        <p id="detalheEquipeMAN" class="form-control-plaintext border p-2 bg-light rounded"></p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold text-primary">
                                            <i class="fas fa-flag me-1"></i>Status:
                                        </label>
                                        <p id="detalheStatusMAN" class="form-control-plaintext border p-2 bg-light rounded"></p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold text-primary">
                                            <i class="fas fa-box me-1"></i>Produto:
                                        </label>
                                        <p id="detalheProdutoMAN" class="form-control-plaintext border p-2 bg-light rounded"></p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold text-primary">
                                            <i class="fas fa-user me-1"></i>Respons√°vel:
                                        </label>
                                        <p id="detalheResponsavelMAN" class="form-control-plaintext border p-2 bg-light rounded"></p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold text-primary">
                                            <i class="fas fa-calendar me-1"></i>Origem:
                                        </label>
                                        <p id="detalheOrigemMAN" class="form-control-plaintext border p-2 bg-light rounded"></p>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-bold text-primary">
                                        <i class="fas fa-align-left me-1"></i>Resumo:
                                    </label>
                                    <div id="detalheResumoMAN" class="border p-3 bg-light rounded" style="min-height: 60px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dados de Datas e Tempo -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-primary fw-bold">
                            <i class="fas fa-calendar-alt me-1"></i>Timeline da MAN
                        </h6>
                        <hr>
                        <div class="card border-info mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-info mb-3">üìÖ Datas Importantes</h6>
                                        <div class="mb-2">
                                            <small class="text-muted fw-bold">Data de Cria√ß√£o:</small>
                                            <div id="detalheCriacaoMAN" class="border p-2 bg-light rounded"></div>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted fw-bold">√öltima Atualiza√ß√£o:</small>
                                            <div id="detalheAtualizacaoMAN" class="border p-2 bg-light rounded"></div>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted fw-bold">Data de Resolu√ß√£o:</small>
                                            <div id="detalheResolucaoMAN" class="border p-2 bg-light rounded"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-success mb-3">‚è±Ô∏è Tempo de Resolu√ß√£o</h6>
                                        <div class="mb-2">
                                            <small class="text-muted fw-bold">Tempo Total:</small>
                                            <div id="detalheTempoResolucaoMAN" class="border p-2 bg-light rounded"></div>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted fw-bold">Status Atual:</small>
                                            <div id="detalheStatusAtualMAN" class="border p-2 bg-light rounded"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes T√©cnicas -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-primary fw-bold">
                            <i class="fas fa-cogs me-1"></i>Informa√ß√µes T√©cnicas
                        </h6>
                        <hr>
                        <div class="card border-warning mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <small class="text-muted fw-bold">ID Interno:</small>
                                            <div id="detalheIDMAN" class="border p-2 bg-light rounded"></div>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted fw-bold">Projeto:</small>
                                            <div id="detalheProjetoMAN" class="border p-2 bg-light rounded"></div>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted fw-bold">Service Pack:</small>
                                            <div id="detalheServicePackMAN" class="border p-2 bg-light rounded"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <small class="text-muted fw-bold">Patch:</small>
                                            <div id="detalhePatchMAN" class="border p-2 bg-light rounded"></div>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted fw-bold">V√≠nculos:</small>
                                            <div id="detalheVinculosMAN" class="border p-2 bg-light rounded"></div>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted fw-bold">Tipo de Issue:</small>
                                            <div id="detalheTipoMAN" class="border p-2 bg-light rounded"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary modern-btn" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Fechar
                </button>
                <button type="button" class="btn btn-primary modern-btn" id="btnCopiarDetalhesMAN">
                    <i class="fas fa-copy me-1"></i>
                    Copiar Informa√ß√µes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
let mansData = [];
let allMansData = [];
let filteredMansData = [];
let currentPageMans = 1;
let pageSizeMans = 25;

let mansFilters = {
    equipe: "",
    status: "",
    produto: "",
    search: "",
    data_inicio: "",
    data_fim: "",
    periodo: "ano_atual"
};

// ==========================================
// CARREGAMENTO INICIAL DOS DADOS
// ==========================================

function loadMansData(applyFilters = false, customFilters = null) {
    console.log('=== CARREGANDO DADOS DAS MANs ===');
    console.log('applyFilters:', applyFilters);
    console.log('customFilters:', customFilters);
    
    document.getElementById('loadingMans').style.display = 'block';
    document.getElementById('tableContainerMans').style.display = 'none';
    document.getElementById('errorMans').style.display = 'none';
    
    // Construir par√¢metros para a API
    let url = '/api/mans-report-table-data';
    const params = new URLSearchParams();
    
    if (applyFilters || customFilters) {
        const filters = customFilters || mansFilters;
        
        console.log('=== CONSTRUINDO PAR√ÇMETROS DA API ===');
        console.log('Filtros a serem enviados:', filters);
        
        // Adicionar filtros de per√≠odo e backend
        if (filters.periodo) {
            params.append('periodo', filters.periodo);
        }
        
        if (filters.data_inicio) {
            params.append('data_inicio', filters.data_inicio);
        }
        
        if (filters.data_fim) {
            params.append('data_fim', filters.data_fim);
        }
        
        // IMPORTANTE: Para filtros de backend, enviar apenas filtros que alteram volume de dados
        // Equipe, status, produto ser√£o filtrados no frontend para performance
        if (filters.search) {
            params.append('search', filters.search);
        }
    }
    
    if (params.toString()) {
        url += '?' + params.toString();
    }
    
    console.log('URL final:', url);
    
    fetch(url)
        .then(response => {
            console.log('Resposta status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Dados recebidos:', data);
            
            document.getElementById('loadingMans').style.display = 'none';
            
            if (data.error) {
                showErrorMans(data.error);
                return;
            }
            
            if (!data.mans) {
                showErrorMans('Dados inv√°lidos do servidor');
                return;
            }
            
            console.log('Total de MANs recebidas:', data.mans.length);
            
            // Armazenar dados - IMPORTANTE: usar allMansData para filtros frontend
             allMansData = data.mans || [];
            mansData = allMansData;
            
            // Atualizar per√≠odo se recebido do backend
            if (data.filtros_aplicados) {
                console.log('Filtros aplicados no backend:', data.filtros_aplicados);
                
                // Sincronizar filtros frontend com backend
                if (data.filtros_aplicados.periodo) {
                    mansFilters.periodo = data.filtros_aplicados.periodo;
                }
                if (data.filtros_aplicados.data_inicio) {
                    mansFilters.data_inicio = data.filtros_aplicados.data_inicio;
                }
                if (data.filtros_aplicados.data_fim) {
                    mansFilters.data_fim = data.filtros_aplicados.data_fim;
                }
            }
            
            // PRIMEIRO: Popular filtros (preservando valores selecionados)
            populateFiltersMans();
            
            // SEGUNDO: Aplicar filtros frontend
            applyFrontendFiltersMans();
            
            // TERCEIRO: Mostrar tabela
            document.getElementById('tableContainerMans').style.display = 'block';
            
            // QUARTO: Atualizar texto do per√≠odo
            updatePeriodoTextoMans();
            
        })
        .catch(error => {
            console.error('Erro completo:', error);
            document.getElementById('loadingMans').style.display = 'none';
            showErrorMans('Erro ao carregar dados: ' + error.message);
        });
}


// ==========================================
// FILTROS SIMPLIFICADOS
// ==========================================


function applyFiltersMans() {
    // Capturar valores dos filtros
    mansFilters.equipe = document.getElementById('filterEquipeMans').value;
    mansFilters.status = document.getElementById('filterStatusMans').value;
    mansFilters.produto = document.getElementById('filterProdutoMans').value;
    mansFilters.search = document.getElementById('searchMans').value.toLowerCase();
    mansFilters.periodo = document.getElementById('filterPeriodoMans').value;
    
    // Calcular datas baseadas no per√≠odo selecionado
    calculatePeriodDates();
    
    console.log('Filtros aplicados:', mansFilters);

    // Aplicar filtros apenas no frontend (para carregamento inicial)
    applyFrontendFiltersMans();
}


function applyFiltersWithBackend() {
    console.log('=== APLICANDO FILTROS COM BACKEND ===');
    
    // Capturar TODOS os valores dos filtros
    mansFilters.equipe = document.getElementById('filterEquipeMans').value;
    mansFilters.status = document.getElementById('filterStatusMans').value;
    mansFilters.produto = document.getElementById('filterProdutoMans').value;
    mansFilters.search = document.getElementById('searchMans').value.toLowerCase();
    mansFilters.periodo = document.getElementById('filterPeriodoMans').value;
    
    console.log('Filtros capturados ANTES de calcular datas:', mansFilters);
    
    // Calcular datas baseadas no per√≠odo selecionado
    calculatePeriodDates();
    
    console.log('Filtros FINAIS para enviar ao backend:', mansFilters);
    
    // Recarregar dados com filtros aplicados no backend
    loadMansData(true, mansFilters);
}

function applyFrontendFiltersMans() {
    console.log('=== APLICANDO FILTROS NO FRONTEND ===');
    
    // Capturar valores atuais dos filtros
    const equipeAtual = document.getElementById('filterEquipeMans').value;
    const statusAtual = document.getElementById('filterStatusMans').value;
    const produtoAtual = document.getElementById('filterProdutoMans').value;
    const searchAtual = document.getElementById('searchMans').value.toLowerCase().trim();
    
    console.log('Filtros frontend capturados:', {
        equipe: equipeAtual,
        status: statusAtual,
        produto: produtoAtual,
        search: searchAtual
    });
    
    // Atualizar objeto mansFilters com valores atuais
    mansFilters.equipe = equipeAtual;
    mansFilters.status = statusAtual;
    mansFilters.produto = produtoAtual;
    mansFilters.search = searchAtual;
    
    // Aplicar filtros nos dados carregados (allMansData)
    filteredMansData = allMansData.filter(item => {
        
        // Filtro de equipe
        const equipeMatch = !mansFilters.equipe || 
                           (item.Equipe && item.Equipe === mansFilters.equipe);
        
        // Filtro de status  
        const statusMatch = !mansFilters.status || 
                           (item.Status && item.Status === mansFilters.status);
        
        // Filtro de produto
        const produtoMatch = !mansFilters.produto || 
                            (item.Produto && item.Produto === mansFilters.produto);
        
        // Filtro de busca (n√∫mero ou resumo)
        const searchMatch = !mansFilters.search || 
                           (item.Number && item.Number.toLowerCase().includes(mansFilters.search)) ||
                           (item.ProjectKey && item.ProjectKey.toLowerCase().includes(mansFilters.search)) ||
                           (item.Summary && item.Summary.toLowerCase().includes(mansFilters.search));
        
        const resultado = equipeMatch && statusMatch && produtoMatch && searchMatch;
        
        return resultado;
    });

    console.log('Filtros aplicados:', {
        total_original: allMansData.length,
        total_filtrado: filteredMansData.length,
        filtros_ativos: mansFilters
    });

    // Resetar para primeira p√°gina
    currentPageMans = 1;
    
    // Atualizar tabela e contadores
    renderTableMans();
    updateTotalRegistrosMans();
}

function calculatePeriodDates() {
    const today = new Date();
    const currentYear = today.getFullYear();
    
    console.log('Calculando datas para per√≠odo:', mansFilters.periodo);
    
    if (mansFilters.periodo === 'personalizado') {
        mansFilters.data_inicio = document.getElementById('filterDataInicioMans').value;
        mansFilters.data_fim = document.getElementById('filterDataFimMans').value;
    } else {
        // Calcular datas automaticamente baseadas no per√≠odo
        switch(mansFilters.periodo) {
            case 'ano_atual':
                mansFilters.data_inicio = `${currentYear}-01-01`;
                mansFilters.data_fim = `${currentYear}-12-31`;
                break;
            case 'q1':
                mansFilters.data_inicio = `${currentYear}-01-01`;
                mansFilters.data_fim = `${currentYear}-03-31`;
                break;
            case 'q2':
                mansFilters.data_inicio = `${currentYear}-04-01`;
                mansFilters.data_fim = `${currentYear}-06-30`;
                break;
            case 'q3':
                mansFilters.data_inicio = `${currentYear}-07-01`;
                mansFilters.data_fim = `${currentYear}-09-30`;
                break;
            case 'q4':
                mansFilters.data_inicio = `${currentYear}-10-01`;
                mansFilters.data_fim = `${currentYear}-12-31`;
                break;
            case '6_meses':
                const seisMesesAtras = new Date();
                seisMesesAtras.setMonth(today.getMonth() - 6);
                mansFilters.data_inicio = seisMesesAtras.toISOString().split('T')[0];
                mansFilters.data_fim = today.toISOString().split('T')[0];
                break;
            case '3_meses':
                const tresMesesAtras = new Date();
                tresMesesAtras.setMonth(today.getMonth() - 3);
                mansFilters.data_inicio = tresMesesAtras.toISOString().split('T')[0];
                mansFilters.data_fim = today.toISOString().split('T')[0];
                break;
            case 'mes_atual':
                mansFilters.data_inicio = `${currentYear}-${(today.getMonth() + 1).toString().padStart(2, '0')}-01`;
                mansFilters.data_fim = today.toISOString().split('T')[0];
                break;
            default:
                mansFilters.data_inicio = '';
                mansFilters.data_fim = '';
        }
    }
    
    console.log('Datas calculadas:', {
        periodo: mansFilters.periodo,
        data_inicio: mansFilters.data_inicio,
        data_fim: mansFilters.data_fim
    });
}

// ==========================================
// CORRE√á√ÉO: populateFiltersMans - USAR allMansData
// ==========================================

function populateFiltersMans() {
    console.log('Populando filtros MANs - preservando valores selecionados...');
    
    // VERIFICAR se h√° dados para popular
    if (!allMansData || allMansData.length === 0) {
        console.log('Nenhum dado dispon√≠vel para popular filtros');
        return;
    }
    
    console.log('Dados dispon√≠veis para filtros:', allMansData.length, 'registros');
    
    // PRESERVAR valores atualmente selecionados
    const equipeSelect = document.getElementById('filterEquipeMans');
    const produtoSelect = document.getElementById('filterProdutoMans');
    
    const equipeSelecionada = equipeSelect.value;
    const produtoSelecionado = produtoSelect.value;
    
    console.log('Valores preservados:', {
        equipe: equipeSelecionada,
        produto: produtoSelecionado
    });
    
    // *** IMPORTANTE: Usar allMansData em vez de mansData ***
    
    // Preencher filtro de equipes
    const equipes = [...new Set(allMansData.map(item => item.Equipe).filter(e => e && e.trim() !== ''))];
    
    console.log('Equipes encontradas:', equipes);
    
    // Limpar op√ß√µes (exceto a primeira "Todas as Equipes")
    while (equipeSelect.children.length > 1) {
        equipeSelect.removeChild(equipeSelect.lastChild);
    }
    
    // Adicionar novas op√ß√µes de equipes
    equipes.sort().forEach(equipe => {
        const option = document.createElement('option');
        option.value = equipe;
        option.textContent = equipe;
        equipeSelect.appendChild(option);
    });
    
    // RESTAURAR valor selecionado da equipe
    if (equipeSelecionada && equipes.includes(equipeSelecionada)) {
        equipeSelect.value = equipeSelecionada;
        console.log('Valor da equipe restaurado:', equipeSelecionada);
    }

    // Preencher filtro de produtos
    const produtos = [...new Set(allMansData.map(item => item.Produto).filter(p => p && p.trim() !== ''))];
    
    console.log('Produtos encontrados:', produtos);
    
    // Limpar op√ß√µes (exceto a primeira "Todos os Produtos")
    while (produtoSelect.children.length > 1) {
        produtoSelect.removeChild(produtoSelect.lastChild);
    }
    
    // Adicionar novas op√ß√µes de produtos
    produtos.sort().forEach(produto => {
        const option = document.createElement('option');
        option.value = produto;
        option.textContent = produto;
        produtoSelect.appendChild(option);
    });
    
    // RESTAURAR valor selecionado do produto
    if (produtoSelecionado && produtos.includes(produtoSelecionado)) {
        produtoSelect.value = produtoSelecionado;
        console.log('Valor do produto restaurado:', produtoSelecionado);
    }
    
    console.log('Filtros populados com', equipes.length, 'equipes e', produtos.length, 'produtos');
}


function clearFiltersMans() {
    console.log('=== LIMPANDO FILTROS ===');
    
    // Resetar filtros para valores padr√£o
    mansFilters = {
        equipe: "",
        status: "",
        produto: "",
        search: "",
        data_inicio: "",
        data_fim: "",
        periodo: "ano_atual"
    };

    // Limpar campos do formul√°rio
    document.getElementById('filterEquipeMans').value = '';
    document.getElementById('filterStatusMans').value = '';
    document.getElementById('filterProdutoMans').value = '';
    document.getElementById('searchMans').value = '';
    document.getElementById('filterPeriodoMans').value = 'ano_atual';
    document.getElementById('filterDataInicioMans').value = '';
    document.getElementById('filterDataFimMans').value = '';
    
    // Esconder datas personalizadas
    document.getElementById('datas-personalizadas-mans').style.display = 'none';
    
    // Calcular datas do ano atual
    calculatePeriodDates();
    
    console.log('Filtros limpos e datas calculadas:', mansFilters);
    
    // Atualizar texto do per√≠odo
    updatePeriodoTextoMans();
    
    // Recarregar dados do backend com filtros limpos
    loadMansData(true, mansFilters);
}



// ==========================================
// RENDERIZA√á√ÉO DA TABELA
// ==========================================


function renderTableMans() {
    const tbody = document.getElementById('tbodyMans');
    const startIndex = (currentPageMans - 1) * pageSizeMans;
    const endIndex = Math.min(startIndex + pageSizeMans, filteredMansData.length);
    const pageData = filteredMansData.slice(startIndex, endIndex);

    tbody.innerHTML = '';

    pageData.forEach((item, index) => {
        const row = document.createElement('tr');
        
        const truncateText = (text, maxLength = 40) => {
            if (!text) return 'Sem resumo';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return 'N√£o definido';
            try {
                return new Date(dateStr).toLocaleDateString('pt-BR');
            } catch {
                return dateStr;
            }
        };

        const getStatusClass = (status) => {
            switch(status) {
                case 'Done':
                case 'Closed':
                case 'Resolved': return 'badge bg-success';
                case 'In Progress': return 'badge bg-primary';
                case 'Open': return 'badge bg-danger';
                case 'To Do': return 'badge bg-secondary';
                default: return 'badge bg-light text-dark';
            }
        };

        row.innerHTML = `
            <td class="fw-bold text-primary">${item.ProjectKey || 'N/A'}</td>
            <td title="${item.Summary || ''}">${truncateText(item.Summary)}</td>
            <td><span class="badge bg-info">${item.Equipe || 'Sem Equipe'}</span></td>
            <td><span class="${getStatusClass(item.Status)}">${item.Status || 'Indefinido'}</span></td>
            <td><span class="badge bg-secondary">${item.Produto || 'N/A'}</span></td>
            <td>${item.Assignee || 'N√£o atribu√≠do'}</td>
            <td><small>${formatDate(item.Created)}</small></td>
            <td><small>${formatDate(item.ResolutionDate) || '-'}</small></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="showMANDetails(${startIndex + index})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });

    renderPaginationMans();
    updateTableInfoMans();
}


function renderPaginationMans() {
    const pagination = document.getElementById('paginationMans');
    const totalPages = Math.ceil(filteredMansData.length / pageSizeMans);
    
    pagination.innerHTML = '';

    if (totalPages <= 1) return;

    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPageMans === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePageMans(${currentPageMans - 1})">Anterior</a>`;
    pagination.appendChild(prevLi);

    const startPage = Math.max(1, currentPageMans - 2);
    const endPage = Math.min(totalPages, currentPageMans + 2);

    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPageMans ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePageMans(${i})">${i}</a>`;
        pagination.appendChild(li);
    }

    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPageMans === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePageMans(${currentPageMans + 1})">Pr√≥ximo</a>`;
    pagination.appendChild(nextLi);
}

function changePageMans(page) {
    const totalPages = Math.ceil(filteredMansData.length / pageSizeMans);
    if (page >= 1 && page <= totalPages) {
        currentPageMans = page;
        renderTableMans();
    }
}

function updateTableInfoMans() {
    const startIndex = (currentPageMans - 1) * pageSizeMans + 1;
    const endIndex = Math.min(currentPageMans * pageSizeMans, filteredMansData.length);
    
    document.getElementById('showingFromMans').textContent = filteredMansData.length > 0 ? startIndex : 0;
    document.getElementById('showingToMans').textContent = endIndex;
    document.getElementById('totalRecordsMans').textContent = filteredMansData.length;
}

function updateTotalRegistrosMans() {
    document.getElementById('totalRegistrosMans').textContent = `${filteredMansData.length} MANs`;
}

function updatePeriodoTextoMans() {
    const periodoTexto = document.getElementById('periodo-texto-mans');
    const periodo = mansFilters.periodo;
    
    const today = new Date();
    const currentYear = today.getFullYear();
    
    let texto = '';
    switch(periodo) {
        case 'ano_atual':
            texto = `${currentYear}`;
            break;
        case 'q1':
            texto = `Q1 ${currentYear} (Jan-Mar)`;
            break;
        case 'q2':
            texto = `Q2 ${currentYear} (Abr-Jun)`;
            break;
        case 'q3':
            texto = `Q3 ${currentYear} (Jul-Set)`;
            break;
        case 'q4':
            texto = `Q4 ${currentYear} (Out-Dez)`;
            break;
        case '6_meses':
            texto = '√öltimos 6 Meses';
            break;
        case '3_meses':
            texto = '√öltimos 3 Meses';
            break;
        case 'mes_atual':
            texto = today.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            break;
        case 'personalizado':
            if (mansFilters.data_inicio && mansFilters.data_fim) {
                texto = `${mansFilters.data_inicio} at√© ${mansFilters.data_fim}`;
            } else if (mansFilters.data_inicio) {
                texto = `A partir de ${mansFilters.data_inicio}`;
            } else if (mansFilters.data_fim) {
                texto = `At√© ${mansFilters.data_fim}`;
            } else {
                texto = 'Personalizado (sem datas)';
            }
            break;
        default:
            texto = 'Todos os Per√≠odos';
    }
    
    if (periodoTexto) {
        periodoTexto.textContent = texto;
    }
}

// ==========================================
// MODAL DE DETALHES
// ==========================================

function showMANDetails(index) {
    const item = filteredMansData[index];
    if (!item) return;

    console.log('Abrindo detalhes para MAN:', item);

    const formatModalData = (data, defaultText = 'N√£o informado') => {
        if (!data || data === '' || data === null || data === undefined || data === '-') {
            return defaultText;
        }
        return data;
    };

    const formatDate = (dateStr) => {
        if (!dateStr || dateStr === '' || dateStr === '-') {
            return '<span class="text-muted">N√£o definida</span>';
        }
        try {
            return `<span class="text-dark">${new Date(dateStr).toLocaleString('pt-BR')}</span>`;
        } catch {
            return `<span class="text-dark">${dateStr}</span>`;
        }
    };

    // Preencher dados b√°sicos da MAN
    document.getElementById('detalheNumeroMAN').textContent = formatModalData(item.Number, 'N/A');
    document.getElementById('detalheEquipeMAN').textContent = formatModalData(item.Equipe, 'Sem equipe');
    document.getElementById('detalheStatusMAN').textContent = formatModalData(item.Status, 'Indefinido');
    document.getElementById('detalheProdutoMAN').textContent = formatModalData(item.Produto, 'Sem produto');
    document.getElementById('detalheResponsavelMAN').textContent = formatModalData(item.Assignee, 'N√£o atribu√≠do');
    document.getElementById('detalheOrigemMAN').textContent = formatModalData(item.OrigemAbertura, 'N√£o informada');
    document.getElementById('detalheResumoMAN').textContent = formatModalData(item.Summary, 'Sem resumo dispon√≠vel');

    // Preencher timeline
    document.getElementById('detalheCriacaoMAN').innerHTML = formatDate(item.Created);
    document.getElementById('detalheAtualizacaoMAN').innerHTML = formatDate(item.Updated);
    document.getElementById('detalheResolucaoMAN').innerHTML = formatDate(item.ResolutionDate);

    // Calcular tempo de resolu√ß√£o
    let tempoResolucao = 'N/A';
    if (item.ResolutionDate && item.Created) {
        try {
            const created = new Date(item.Created);
            const resolved = new Date(item.ResolutionDate);
            const diffTime = Math.abs(resolved - created);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            tempoResolucao = `${diffDays} dias`;
        } catch (e) {
            tempoResolucao = 'Erro no c√°lculo';
        }
    } else if (!item.ResolutionDate && item.Created) {
        try {
            const created = new Date(item.Created);
            const now = new Date();
            const diffTime = Math.abs(now - created);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            tempoResolucao = `${diffDays} dias (em aberto)`;
        } catch (e) {
            tempoResolucao = 'Ainda em aberto';
        }
    }

    document.getElementById('detalheTempoResolucaoMAN').innerHTML = `<span class="text-dark fw-bold">${tempoResolucao}</span>`;
    
    // Status atual
    let statusAtual = 'Em aberto';
    if (['Done', 'Closed', 'Resolved'].includes(item.Status)) {
        statusAtual = 'Resolvida';
    } else if (['In Progress'].includes(item.Status)) {
        statusAtual = 'Em progresso';
    }
    document.getElementById('detalheStatusAtualMAN').innerHTML = `<span class="badge bg-info">${statusAtual}</span>`;

    // Preencher informa√ß√µes t√©cnicas
    document.getElementById('detalheIDMAN').innerHTML = `<span class="text-dark">${formatModalData(item.ISSUE_ID, 'N/A')}</span>`;
    document.getElementById('detalheProjetoMAN').innerHTML = `<span class="text-dark">${formatModalData(item.Project, 'N/A')}</span>`;
    document.getElementById('detalheServicePackMAN').innerHTML = `<span class="text-dark">${formatModalData(item.ServicePackLiberacao, 'N/A')}</span>`;
    document.getElementById('detalhePatchMAN').innerHTML = `<span class="text-dark">${formatModalData(item.PatchLiberacao, 'N/A')}</span>`;
    document.getElementById('detalheVinculosMAN').innerHTML = `<span class="text-dark">${formatModalData(item.QtdeVinculos || '0', '0')}</span>`;
    document.getElementById('detalheTipoMAN').innerHTML = `<span class="text-dark">${formatModalData(item.IssueType, 'N/A')}</span>`;

    // Configurar bot√£o de c√≥pia
    document.getElementById('btnCopiarDetalhesMAN').onclick = function() {
        copiarDetalhesMAN(item);
    };

    const modal = new bootstrap.Modal(document.getElementById('modalDetalheMAN'));
    modal.show();
}

function copiarDetalhesMAN(man) {
    const texto = `
MAN ${man.ProjectKey || 'N/A'}
Resumo: ${man.Summary || 'Sem resumo'}
Equipe: ${man.Equipe || 'N√£o atribu√≠da'}
Status: ${man.Status || 'N/A'}
Produto: ${man.Produto || 'N/A'}
Respons√°vel: ${man.Assignee || 'N√£o atribu√≠do'}
Cria√ß√£o: ${man.Created ? new Date(man.Created).toLocaleString('pt-BR') : 'N/A'}
Resolu√ß√£o: ${man.ResolutionDate ? new Date(man.ResolutionDate).toLocaleString('pt-BR') : 'N√£o resolvida'}
    `.trim();
    
    navigator.clipboard.writeText(texto).then(() => {
        const btn = document.getElementById('btnCopiarDetalhesMAN');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Copiado!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-primary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.add('btn-primary');
            btn.classList.remove('btn-success');
        }, 2000);
    });
}

// ==========================================
// EXPORTA√á√ÉO SIMPLIFICADA
// ==========================================

function exportFilteredCSVMans() {
    console.log('Exportando MANs filtradas...', filteredMansData.length, 'registros');
    
    if (!filteredMansData || filteredMansData.length === 0) {
        alert('Nenhum dado para exportar com os filtros aplicados.');
        return;
    }
    
    const btnExport = document.getElementById('btnExportCSVMans');
    const originalText = btnExport.innerHTML;
    
    // Feedback visual
    btnExport.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Exportando ${filteredMansData.length} MANs...`;
    btnExport.disabled = true;
    
    try {
        // Criar CSV
        const csvContent = createCSVFromFilteredData();
        
        // Fazer download do arquivo
        downloadCSV(csvContent, generateExportFilename());
        
        // Mostrar mensagem de sucesso
        showExportSuccessMans(filteredMansData.length);
        
    } catch (error) {
        console.error('Erro na exporta√ß√£o:', error);
        alert('Erro ao exportar dados: ' + error.message);
    } finally {
        // Restaurar bot√£o
        setTimeout(() => {
            btnExport.innerHTML = originalText;
            btnExport.disabled = false;
        }, 1000);
    }
}

function createCSVFromFilteredData() {
    // Cabe√ßalhos do CSV
    const headers = [
        'N√∫mero MAN',
        'Resumo', 
        'Equipe',
        'Status',
        'Produto',
        'Respons√°vel',
        'Data Cria√ß√£o',
        'Data Atualiza√ß√£o',
        'Data Resolu√ß√£o',
        'Tempo Resolu√ß√£o (Dias)',
        'Origem Abertura',
        'Service Pack',
        'Patch',
        'Quantidade V√≠nculos',
        'Chave Projeto',
        'Tipo Issue',
        'Situa√ß√£o'
    ];
    
    // Fun√ß√£o para formatar data
    const formatDate = (dateStr) => {
        if (!dateStr) return '';
        try {
            return new Date(dateStr).toLocaleDateString('pt-BR') + ' ' + 
                   new Date(dateStr).toLocaleTimeString('pt-BR');
        } catch {
            return dateStr;
        }
    };
    
    // Fun√ß√£o para calcular tempo de resolu√ß√£o
    const calculateResolutionTime = (created, resolved) => {
        if (!created || !resolved) return '';
        try {
            const createdDate = new Date(created);
            const resolvedDate = new Date(resolved);
            const diffTime = Math.abs(resolvedDate - createdDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays.toString();
        } catch {
            return '';
        }
    };
    
    // Fun√ß√£o para determinar situa√ß√£o
    const getSituacao = (status, resolutionDate) => {
        if (resolutionDate) return 'Resolvida';
        if (['Closed', 'Done', 'Resolved'].includes(status)) return 'Fechada';
        if (['In Progress', 'Development'].includes(status)) return 'Em Andamento';
        return 'Aberta';
    };
    
    // Criar linhas do CSV
    const rows = filteredMansData.map(item => {
        return [
            item.Number || 'N/A',
            (item.Summary || 'Sem resumo').replace(/"/g, '""'), // Escapar aspas
            item.Equipe || 'Sem Equipe',
            item.Status || 'Indefinido',
            item.Produto || 'Sem Produto',
            item.Assignee || 'N√£o Atribu√≠do',
            formatDate(item.Created),
            formatDate(item.Updated),
            formatDate(item.ResolutionDate),
            calculateResolutionTime(item.Created, item.ResolutionDate),
            item.OrigemAbertura || 'N√£o Informada',
            item.ServicePackLiberacao || 'N/A',
            item.PatchLiberacao || 'N/A',
            item.QtdeVinculos || '0',
            item.ProjectKey || 'N/A',
            item.IssueType || 'N/A',
            getSituacao(item.Status, item.ResolutionDate)
        ];
    });
    
    // Combinar cabe√ßalhos e dados
    const csvData = [headers, ...rows];
    
    // Converter para string CSV com separador ponto e v√≠rgula
    return csvData.map(row => 
        row.map(field => `"${field}"`).join(';')
    ).join('\n');
}

function generateExportFilename() {
    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
    const totalRecords = filteredMansData.length;
    
    let filename = `relatorio_mans_${totalRecords}registros_${timestamp}`;
    
    // Adicionar informa√ß√µes dos filtros aplicados
    if (mansFilters.equipe) {
        filename += `_equipe_${mansFilters.equipe.replace(/[^a-zA-Z0-9]/g, '_')}`;
    }
    
    if (mansFilters.status) {
        filename += `_status_${mansFilters.status.replace(/[^a-zA-Z0-9]/g, '_')}`;
    }
    
    if (mansFilters.produto) {
        filename += `_produto_${mansFilters.produto.replace(/[^a-zA-Z0-9]/g, '_')}`;
    }
    
    if (mansFilters.search) {
        filename += `_busca_${mansFilters.search.slice(0, 10).replace(/[^a-zA-Z0-9]/g, '_')}`;
    }
    
    if (mansFilters.periodo !== 'ano_atual') {
        filename += `_periodo_${mansFilters.periodo}`;
    }
    
    return filename + '.csv';
}

function downloadCSV(csvContent, filename) {
    // Adicionar BOM para UTF-8 (para que o Excel reconhe√ßa acentos)
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    
    // Criar link de download
    const link = document.createElement('a');
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    } else {
        // Fallback para navegadores antigos
        window.open('data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
    }
}

function showExportSuccessMans(totalRegistros) {
    // Criar toast de sucesso
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                Exporta√ß√£o de MANs conclu√≠da! ${totalRegistros} registros exportados.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Mostrar toast
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 4000
    });
    bsToast.show();
    
    // Remover toast ap√≥s ser ocultado
    toast.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(toast);
    });
}

// ==========================================
// FUN√á√ïES AUXILIARES
// ==========================================


// Fun√ß√£o de debounce para evitar muitas chamadas √† API
let debounceTimer;
function debounceApiCall(func, delay = 1000) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(func, delay);
}

// Fun√ß√£o para validar se uma data est√° no formato correto
function isValidDate(dateString) {
    if (!dateString) return false;
    const regex = /^\d{4}-\d{2}-\d{2}$/;
    if (!regex.test(dateString)) return false;
    const date = new Date(dateString);
    return date instanceof Date && !isNaN(date);
}

function showErrorMans(message) {
    document.getElementById('errorMessageMans').textContent = message;
    document.getElementById('errorMans').style.display = 'block';
}

// ==========================================
// EVENT LISTENERS
// ==========================================

// Esta fun√ß√£o configura os event listeners existentes no DOMContentLoaded
function setupEventListenersMans() {
    console.log('Configurando event listeners para MANs...');
    
    // *** FILTROS FRONTEND - aplicam filtro imediatamente nos dados carregados ***
    
    // Equipe - filtro frontend
    document.getElementById('filterEquipeMans').addEventListener('change', function() {
        console.log('Mudan√ßa na equipe:', this.value);
        applyFrontendFiltersMans();
    });
    
    // Status - filtro frontend  
    document.getElementById('filterStatusMans').addEventListener('change', function() {
        console.log('Mudan√ßa no status:', this.value);
        applyFrontendFiltersMans();
    });
    
    // Produto - filtro frontend
    document.getElementById('filterProdutoMans').addEventListener('change', function() {
        console.log('Mudan√ßa no produto:', this.value);
        applyFrontendFiltersMans();
    });
    
    // Busca - filtro frontend com debounce
    let searchTimeout;
    document.getElementById('searchMans').addEventListener('input', function() {
        console.log('Mudan√ßa na busca:', this.value);
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            applyFrontendFiltersMans();
        }, 300); // Debounce de 300ms para n√£o filtrar a cada tecla
    });

    // *** FILTROS BACKEND - recarregam dados do servidor ***
    
    // Per√≠odo - chama backend
    document.getElementById('filterPeriodoMans').addEventListener('change', function() {
        const periodo = this.value;
        const datasPersonalizadas = document.getElementById('datas-personalizadas-mans');

        console.log('=== MUDAN√áA DE PER√çODO - BACKEND ===');
        console.log('Per√≠odo selecionado:', periodo);

        mansFilters.periodo = periodo;

        if (periodo === 'personalizado') {
            datasPersonalizadas.style.display = 'block';
            const anoAtual = new Date().getFullYear();
            const dataInicio = `${anoAtual}-01-01`;
            const dataFim = `${anoAtual}-12-31`;
            document.getElementById('filterDataInicioMans').value = dataInicio;
            document.getElementById('filterDataFimMans').value = dataFim;
            
            mansFilters.data_inicio = dataInicio;
            mansFilters.data_fim = dataFim;
        } else {
            datasPersonalizadas.style.display = 'none';
            document.getElementById('filterDataInicioMans').value = '';
            document.getElementById('filterDataFimMans').value = '';
            
            calculatePeriodDates();
        }

        updatePeriodoTextoMans();
        loadMansData(true, mansFilters); // Chamar backend
    });

    // Datas personalizadas - chamam backend
    document.getElementById('filterDataInicioMans').addEventListener('blur', function() {
        if (mansFilters.periodo === 'personalizado') {
            const dataInicio = this.value;
            if (isValidDate(dataInicio)) {
                mansFilters.data_inicio = dataInicio;
                console.log('Data in√≠cio alterada (backend):', dataInicio);
                debounceApiCall(() => loadMansData(true, mansFilters), 500);
            } else if (dataInicio === '') {
                mansFilters.data_inicio = '';
            }
        }
    });
    
    document.getElementById('filterDataFimMans').addEventListener('blur', function() {
        if (mansFilters.periodo === 'personalizado') {
            const dataFim = this.value;
            if (isValidDate(dataFim)) {
                mansFilters.data_fim = dataFim;
                console.log('Data fim alterada (backend):', dataFim);
                debounceApiCall(() => loadMansData(true, mansFilters), 500);
            } else if (dataFim === '') {
                mansFilters.data_fim = '';
            }
        }
    });

    // Atualiza√ß√£o em tempo real do texto (s√≥ visual)
    document.getElementById('filterDataInicioMans').addEventListener('input', function() {
        if (mansFilters.periodo === 'personalizado') {
            mansFilters.data_inicio = this.value;
            updatePeriodoTextoMans();
        }
    });
    
    document.getElementById('filterDataFimMans').addEventListener('input', function() {
        if (mansFilters.periodo === 'personalizado') {
            mansFilters.data_fim = this.value;
            updatePeriodoTextoMans();
        }
    });

    // *** BOT√ïES - a√ß√µes espec√≠ficas ***
    
    // Aplicar filtros - backend
    document.getElementById('btnAplicarFiltrosMans').addEventListener('click', function() {
        console.log('Bot√£o APLICAR clicado - chamando backend');
        applyFiltersWithBackend();
    });
    
    // Limpar filtros - backend  
    document.getElementById('btnLimparFiltrosMans').addEventListener('click', function() {
        console.log('Bot√£o LIMPAR clicado - chamando backend');
        clearFiltersMans();
    });

    // Refresh - carregamento inicial
    document.getElementById('btnRefreshMans').addEventListener('click', function() {
        console.log('Bot√£o REFRESH clicado');
        document.getElementById('tableContainerMans').style.display = 'none';
        document.getElementById('errorMans').style.display = 'none';
        document.getElementById('loadingMans').style.display = 'block';
        loadMansData(false); // Carregamento inicial
    });

    // Tamanho da p√°gina
    document.getElementById('pageSizeMans').addEventListener('change', function() {
        pageSizeMans = parseInt(this.value);
        currentPageMans = 1;
        renderTableMans();
    });

    // Exporta√ß√£o
    document.getElementById('btnExportCSVMans').addEventListener('click', exportFilteredCSVMans);
}


document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando p√°gina de MANs com corre√ß√µes...');
    
    // Configurar todos os event listeners
    setupEventListenersMans();
    
    // Carregar dados iniciais (sem filtros aplicados)
    loadMansData(false);
});




</script>
{% endblock %}