{% extends "base.html" %}

{% block title %}Dashboard - Sistema de Projetos{% endblock %}
{% block dashboard_active %}active{% endblock %}
{% block page_title %}Dashboard Executivo{% endblock %}

{% block content %}
<!-- Filtros Superiores -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-body bg-light">
                <div class="row align-items-center">
                    <div class="col-md-2">
                        <label for="filterEquipeDash" class="form-label small fw-bold">Equipe</label>
                        <select id="filterEquipeDash" class="form-select form-select-sm">
                            <option value="">Todas as Equipes</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filterProdutoDash" class="form-label small fw-bold">Produto</label>
                        <select id="filterProdutoDash" class="form-select form-select-sm">
                            <option value="">Todos os Produtos</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filterPeriodoDash" class="form-label small fw-bold">Período</label>
                        <select id="filterPeriodoDash" class="form-select form-select-sm">
                            <option value="ano_atual">Ano Atual</option>
                            <option value="6_meses">Últimos 6 Meses</option>
                            <option value="3_meses">Últimos 3 Meses</option>
                            <option value="mes_atual">Mês Atual</option>
                            <option value="todos">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterStatusDash" class="form-label small fw-bold">Status</label>
                        <select id="filterStatusDash" class="form-select form-select-sm" multiple>
                            <option value="">Todos os Status</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button id="btnAtualizarDash" class="btn btn-primary btn-sm me-2">
                            <i class="fas fa-sync-alt me-1"></i>
                            Atualizar
                        </button>
                        <button id="btnExportDash" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-download me-1"></i>
                            Exportar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Indicadores Principais -->
<div class="row mb-4">
    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1" style="color: #5a5c69;">
                            Total de Épicos
                        </div>
                        <div class="h4 mb-0 font-weight-bold text-gray-800" id="totalEpicos">
                            {{ stats.total_epicos or 0 }}
                        </div>
                        <div class="mt-2 d-flex align-items-center">
                            <span class="text-success small fw-bold" id="epicosTendencia">
                                <i class="fas fa-arrow-up me-1"></i>12%
                            </span>
                            <span class="text-muted small ms-1">vs mês anterior</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="icon-circle bg-primary">
                            <i class="fas fa-project-diagram text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1" style="color: #1cc88a;">
                            Taxa de Conclusão
                        </div>
                        <div class="h4 mb-0 font-weight-bold text-gray-800" id="taxaConclusao">
                            {% if stats.total_epicos and stats.total_epicos > 0 %}
                                {{ "%.1f"|format((stats.epicos_concluidos or 0) / stats.total_epicos * 100) }}%
                            {% else %}
                                0.0%
                            {% endif %}
                        </div>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {% if stats.total_epicos and stats.total_epicos > 0 %}{{ (stats.epicos_concluidos or 0) / stats.total_epicos * 100 }}{% else %}0{% endif %}%">
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="icon-circle bg-success">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1" style="color: #36b9cc;">
                            Progresso Médio
                        </div>
                        <div class="h4 mb-0 font-weight-bold text-gray-800" id="progressoMedio">
                            {{ "%.1f"|format(stats.percentual_medio or 0) }}%
                        </div>
                        <div class="mt-2">
                            <span class="badge bg-info" id="statusProgresso">No Prazo</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="icon-circle bg-info">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1" style="color: #f6c23e;">
                            Épicos Atrasados
                        </div>
                        <div class="h4 mb-0 font-weight-bold text-gray-800" id="epicosAtrasados">
                            {{ stats.epicos_atrasados or 0 }}
                        </div>
                        <div class="mt-2">
                            <span class="text-warning small fw-bold" id="percentualAtrasados">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                {% if stats.total_epicos and stats.total_epicos > 0 %}
                                    {{ "%.1f"|format((stats.epicos_atrasados or 0) / stats.total_epicos * 100) }}%
                                {% else %}
                                    0.0%
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="icon-circle bg-warning">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cards de Análise Detalhada -->
<div class="row mb-4">
    <!-- Performance por Equipe -->
    <div class="col-xl-4 col-lg-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-users me-2"></i>Performance por Equipe
                </h6>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportEquipeData()">Exportar Dados</a></li>
                        <li><a class="dropdown-item" href="/relatorio-epicos">Ver Detalhes</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <div id="performanceEquipes" style="height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- Status Distribution -->
    <div class="col-xl-4 col-lg-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-pie me-2"></i>Distribuição por Status
                </h6>
            </div>
            <div class="card-body">
                <div id="statusDistribution" style="height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- Timeline de Entregas -->
    <div class="col-xl-4 col-lg-12 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calendar-alt me-2"></i>Timeline de Entregas
                </h6>
            </div>
            <div class="card-body">
                <div id="timelineEntregas" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Alertas e Ações -->
<div class="row mb-4">
    <div class="col-xl-8 col-lg-7">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-exclamation-triangle me-2"></i>Alertas e Riscos
                </h6>
            </div>
            <div class="card-body">
                <div id="alertas-container">
                    <!-- Alertas dinâmicos aqui -->
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-lg-5">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-rocket me-2"></i>Ações Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <a href="/gantt" class="btn btn-primary d-flex align-items-center">
                        <i class="fas fa-chart-gantt me-3"></i>
                        <div class="text-start">
                            <div class="fw-bold">Gráfico de Gantt</div>
                            <small class="text-white-50">Visualização de cronograma</small>
                        </div>
                    </a>
                    <a href="/relatorio-epicos" class="btn btn-info d-flex align-items-center">
                        <i class="fas fa-list-alt me-3"></i>
                        <div class="text-start">
                            <div class="fw-bold">Relatório de Épicos</div>
                            <small class="text-white-50">Análise detalhada</small>
                        </div>
                    </a>
                    <a href="/relatorio-subtasks" class="btn btn-success d-flex align-items-center">
                        <i class="fas fa-tasks me-3"></i>
                        <div class="text-start">
                            <div class="fw-bold">Relatório de SubTasks</div>
                            <small class="text-white-50">Controle de atividades</small>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer Info -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-3">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-muted small">
                            <i class="fas fa-sync-alt me-1"></i>
                            Última atualização: <span id="ultimaAtualizacao">Carregando...</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">
                            <i class="fas fa-database me-1"></i>
                            Total de registros: <span id="totalRegistros">{{ (stats.total_epicos or 0) + (stats.total_subtasks or 0) }}</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">
                            <i class="fas fa-clock me-1"></i>
                            Próxima atualização: <span id="proximaAtualizacao">em 5 minutos</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estilos personalizados -->
<style>
.icon-circle {
    height: 3rem;
    width: 3rem;
    border-radius: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.card {
    transition: transform 0.15s ease-in-out;
    border: none !important;
}

.card:hover {
    transform: translateY(-1px);
}

.bg-gradient-primary {
    background: linear-gradient(180deg, #4e73df 10%, #224abe 100%);
}

.bg-gradient-success {
    background: linear-gradient(180deg, #1cc88a 10%, #13855c 100%);
}

.bg-gradient-info {
    background: linear-gradient(180deg, #36b9cc 10%, #258391 100%);
}

.bg-gradient-warning {
    background: linear-gradient(180deg, #f6c23e 10%, #dda20a 100%);
}

.alert-dashboard {
    border-left: 4px solid;
    border-radius: 0.35rem;
    margin-bottom: 1rem;
}

.alert-high { border-left-color: #dc3545; }
.alert-medium { border-left-color: #ffc107; }
.alert-low { border-left-color: #17a2b8; }

.text-xs {
    font-size: 0.7rem;
}

.shadow-sm {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Dados globais
let dashboardData = {
    stats: {{ stats | tojson }},
    equipes: {{ equipes | tojson }}
};

// Configuração de cores
const colors = {
    primary: '#4e73df',
    success: '#1cc88a',
    info: '#36b9cc',
    warning: '#f6c23e',
    danger: '#e74a3b',
    secondary: '#858796'
};

// Inicialização do Dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando Dashboard...');
    initializeDashboard();
    loadFilterOptions();
    createCharts();
    generateAlerts();
    updateTimestamp(); // Atualizar timestamp imediatamente
    
    // Auto-refresh a cada 5 minutos
    setInterval(refreshDashboard, 300000);
    
    // Atualizar timestamp a cada minuto
    setInterval(updateTimestamp, 60000);
});

function initializeDashboard() {
    console.log('Inicializando Dashboard...', dashboardData);
}

function loadFilterOptions() {
    console.log('Carregando opções de filtros...');
    // Carregar opções de filtros
    fetch('/api/dashboard-filters')
        .then(response => {
            console.log('Resposta filtros:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dados filtros recebidos:', data);
            if (data.error) {
                console.error('Erro ao carregar filtros:', data.error);
            } else {
                populateFilterSelects(data);
            }
        })
        .catch(error => {
            console.error('Erro na requisição de filtros:', error);
            // Mesmo com erro, tentar popular com dados vazios
            populateFilterSelects({equipes: [], produtos: [], status: []});
        });
}

function populateFilterSelects(data) {
    console.log('Populando selects com:', data);
    
    // Popular select de equipes
    const equipeSelect = document.getElementById('filterEquipeDash');
    if (equipeSelect && data.equipes) {
        // Limpar opções existentes (exceto a primeira)
        while (equipeSelect.children.length > 1) {
            equipeSelect.removeChild(equipeSelect.lastChild);
        }
        
        data.equipes.forEach(equipe => {
            const option = document.createElement('option');
            option.value = equipe;
            option.textContent = equipe;
            equipeSelect.appendChild(option);
        });
        console.log(`Adicionadas ${data.equipes.length} equipes`);
    }

    // Popular select de produtos
    const produtoSelect = document.getElementById('filterProdutoDash');
    if (produtoSelect && data.produtos) {
        // Limpar opções existentes (exceto a primeira)
        while (produtoSelect.children.length > 1) {
            produtoSelect.removeChild(produtoSelect.lastChild);
        }
        
        data.produtos.forEach(produto => {
            const option = document.createElement('option');
            option.value = produto;
            option.textContent = produto;
            produtoSelect.appendChild(option);
        });
        console.log(`Adicionados ${data.produtos.length} produtos`);
    }

    // Popular select de status
    const statusSelect = document.getElementById('filterStatusDash');
    if (statusSelect && data.status) {
        // Limpar opções existentes (exceto a primeira)
        while (statusSelect.children.length > 1) {
            statusSelect.removeChild(statusSelect.lastChild);
        }
        
        data.status.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            statusSelect.appendChild(option);
        });
        console.log(`Adicionados ${data.status.length} status`);
    }
}

function createCharts() {
    createPerformanceChart();
    createStatusChart();
    createTimelineChart();
}

function createPerformanceChart() {
    console.log('Criando gráfico de performance...');
    console.log('Dados equipes:', dashboardData.equipes);
    
    if (!dashboardData.equipes || dashboardData.equipes.length === 0) {
        document.getElementById('performanceEquipes').innerHTML = 
            '<div class="text-center text-muted p-4"><i class="fas fa-chart-bar fa-2x mb-2"></i><br>Sem dados disponíveis</div>';
        return;
    }

    const data = [{
        x: dashboardData.equipes.map(e => e.EpicEquipe || 'Sem Equipe'),
        y: dashboardData.equipes.map(e => e.quantidade || 0),
        type: 'bar',
        marker: {
            color: dashboardData.equipes.map(e => {
                const progress = e.percentual_medio || 0;
                if (progress >= 80) return colors.success;
                if (progress >= 50) return colors.warning;
                return colors.danger;
            }),
            opacity: 0.8
        },
        text: dashboardData.equipes.map(e => `${e.quantidade || 0} épicos`),
        textposition: 'auto',
        hovertemplate: '<b>%{x}</b><br>Épicos: %{y}<br>Progresso: %{customdata:.1f}%<extra></extra>',
        customdata: dashboardData.equipes.map(e => e.percentual_medio || 0)
    }];

    const layout = {
        margin: { t: 20, b: 50, l: 50, r: 20 },
        xaxis: { 
            tickangle: -45,
            tickfont: { size: 10 }
        },
        yaxis: { 
            title: 'Quantidade'
        },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        font: { size: 11 }
    };

    Plotly.newPlot('performanceEquipes', data, layout, {
        responsive: true,
        displayModeBar: false
    });
}

function createStatusChart() {
    console.log('Criando gráfico de status...');
    console.log('Dados stats:', dashboardData.stats);
    
    if (!dashboardData.stats || dashboardData.stats.error) {
        document.getElementById('statusDistribution').innerHTML = 
            '<div class="text-center text-muted p-4"><i class="fas fa-chart-pie fa-2x mb-2"></i><br>Sem dados disponíveis</div>';
        return;
    }

    const stats = dashboardData.stats;
    const concluidos = stats.epicos_concluidos || 0;
    const emAndamento = stats.epicos_em_andamento || 0;
    const total = stats.total_epicos || 0;
    const outros = Math.max(0, total - concluidos - emAndamento);
    
    // Se não há dados, mostrar mensagem
    if (total === 0) {
        document.getElementById('statusDistribution').innerHTML = 
            '<div class="text-center text-muted p-4"><i class="fas fa-chart-pie fa-2x mb-2"></i><br>Nenhum épico encontrado</div>';
        return;
    }

    const data = [{
        values: [concluidos, emAndamento, outros],
        labels: ['Concluídos', 'Em Andamento', 'Outros'],
        type: 'pie',
        hole: 0.5,
        marker: {
            colors: [colors.success, colors.info, colors.secondary]
        },
        textinfo: 'label+percent',
        textposition: 'auto',
        hovertemplate: '<b>%{label}</b><br>Quantidade: %{value}<br>Percentual: %{percent}<extra></extra>'
    }];

    const layout = {
        margin: { t: 20, b: 20, l: 20, r: 20 },
        showlegend: false,
        font: { size: 11 }
    };

    Plotly.newPlot('statusDistribution', data, layout, {
        responsive: true,
        displayModeBar: false
    });
}

function createTimelineChart() {
    // Simulação de dados de timeline
    const timelineData = [{
        x: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
        y: [12, 15, 10, 18, 22, 16],
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: colors.primary, width: 3 },
        marker: { size: 8, color: colors.primary },
        name: 'Entregas Planejadas'
    }, {
        x: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
        y: [10, 12, 8, 15, 20, 14],
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: colors.success, width: 3 },
        marker: { size: 8, color: colors.success },
        name: 'Entregas Realizadas'
    }];

    const layout = {
        margin: { t: 20, b: 50, l: 50, r: 20 },
        xaxis: { title: 'Mês' },
        yaxis: { title: 'Épicos' },
        showlegend: true,
        legend: {
            orientation: 'h',
            y: -0.2
        },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        font: { size: 11 }
    };

    Plotly.newPlot('timelineEntregas', timelineData, layout, {
        responsive: true,
        displayModeBar: false
    });
}

function generateAlerts() {
    const alertsContainer = document.getElementById('alertas-container');
    const stats = dashboardData.stats || {};
    
    const alerts = [
        {
            type: 'high',
            icon: 'fas fa-exclamation-circle',
            title: 'Épicos Atrasados',
            message: `${stats.epicos_atrasados || 0} épicos estão com prazo vencido`,
            action: 'Ver Detalhes',
            link: '/relatorio-epicos?status=atrasado'
        },
        {
            type: 'medium',
            icon: 'fas fa-clock',
            title: 'Prazo Próximo',
            message: 'Verificar épicos que vencem nos próximos 7 dias',
            action: 'Verificar',
            link: '/gantt'
        },
        {
            type: 'low',
            icon: 'fas fa-info-circle',
            title: 'Performance',
            message: `Progresso médio atual: ${(stats.percentual_medio || 0).toFixed(1)}%`,
            action: 'Acompanhar',
            link: '/dashboard'
        }
    ];

    if (alertsContainer) {
        alertsContainer.innerHTML = alerts.map(alert => `
            <div class="alert alert-dashboard alert-${alert.type} d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="${alert.icon} text-${alert.type === 'high' ? 'danger' : alert.type === 'medium' ? 'warning' : 'info'}"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h6 class="alert-heading mb-1">${alert.title}</h6>
                    <p class="mb-0">${alert.message}</p>
                </div>
                <div class="flex-shrink-0">
                    <a href="${alert.link}" class="btn btn-sm btn-outline-${alert.type === 'high' ? 'danger' : alert.type === 'medium' ? 'warning' : 'info'}">
                        ${alert.action}
                    </a>
                </div>
            </div>
        `).join('');
    }
}

function updateTimestamp() {
    const now = new Date();
    const timestamp = now.toLocaleString('pt-BR', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    document.getElementById('ultimaAtualizacao').textContent = timestamp;
    
    // Atualizar próxima atualização
    const proxima = new Date(now.getTime() + 5 * 60 * 1000);
    document.getElementById('proximaAtualizacao').textContent = 
        'às ' + proxima.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

function refreshDashboard() {
    // Atualizar dados
    location.reload();
}

function exportEquipeData() {
    // Implementar exportação
    window.open('/export/dashboard-equipes', '_blank');
}

// Event Listeners
document.getElementById('btnAtualizarDash').addEventListener('click', refreshDashboard);
document.getElementById('btnExportDash').addEventListener('click', function() {
    window.open('/export/dashboard-completo', '_blank');
});

// Filtros
document.getElementById('filterEquipeDash').addEventListener('change', applyDashboardFilters);
document.getElementById('filterProdutoDash').addEventListener('change', applyDashboardFilters);
document.getElementById('filterPeriodoDash').addEventListener('change', applyDashboardFilters);

function applyDashboardFilters() {
    console.log('Aplicando filtros do dashboard...');
    
    // Mostrar loading nos cards
    showLoadingInCards();
    
    // Obter valores dos filtros
    const equipe = document.getElementById('filterEquipeDash').value;
    const produto = document.getElementById('filterProdutoDash').value;
    const periodo = document.getElementById('filterPeriodoDash').value;
    const status = Array.from(document.getElementById('filterStatusDash').selectedOptions).map(option => option.value).join(',');
    
    console.log('Filtros selecionados:', { equipe, produto, periodo, status });
    
    // Criar parâmetros da requisição
    const params = new URLSearchParams({
        equipe: equipe,
        produto: produto,
        periodo: periodo,
        status: status
    });
    
    // Fazer requisição para dados filtrados
    fetch(`/api/dashboard-data?${params.toString()}`)
        .then(response => {
            console.log('Resposta dashboard-data:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dados dashboard recebidos:', data);
            
            if (data.error) {
                console.error('Erro nos dados:', data.error);
                hideLoadingInCards();
                showErrorMessage('Erro ao carregar dados: ' + data.error);
            } else {
                // Atualizar dados globais
                dashboardData.stats = data.stats || {};
                dashboardData.equipes = data.equipes || [];
                
                // Atualizar cards
                updateDashboardCards(data.stats);
                
                // Recriar gráficos
                createCharts();
                
                // Atualizar alertas
                generateAlerts();
                
                // Esconder loading
                hideLoadingInCards();
                
                console.log('Dashboard atualizado com sucesso');
            }
        })
        .catch(error => {
            console.error('Erro na requisição dashboard-data:', error);
            hideLoadingInCards();
            showErrorMessage('Erro ao conectar com o servidor');
        });
}

function showLoadingInCards() {
    // Mostrar loading nos cards principais
    const cards = ['totalEpicos', 'taxaConclusao', 'progressoMedio', 'epicosAtrasados'];
    cards.forEach(cardId => {
        const element = document.getElementById(cardId);
        if (element) {
            element.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
    });
}

function hideLoadingInCards() {
    // Loading será removido quando updateDashboardCards for chamado
}

function updateDashboardCards(stats) {
    console.log('Atualizando cards com:', stats);
    
    // Atualizar Total de Épicos
    const totalEpicos = document.getElementById('totalEpicos');
    if (totalEpicos) {
        totalEpicos.textContent = stats.total_epicos || 0;
    }
    
    // Atualizar Taxa de Conclusão
    const taxaConclusao = document.getElementById('taxaConclusao');
    if (taxaConclusao) {
        const taxa = stats.total_epicos > 0 ? 
            ((stats.epicos_concluidos || 0) / stats.total_epicos * 100).toFixed(1) : 
            '0.0';
        taxaConclusao.textContent = taxa + '%';
    }
    
    // Atualizar Progresso Médio
    const progressoMedio = document.getElementById('progressoMedio');
    if (progressoMedio) {
        progressoMedio.textContent = (stats.percentual_medio || 0).toFixed(1) + '%';
    }
    
    // Atualizar Épicos Atrasados
    const epicosAtrasados = document.getElementById('epicosAtrasados');
    if (epicosAtrasados) {
        epicosAtrasados.textContent = stats.epicos_atrasados || 0;
    }
    
    // Atualizar percentual de atrasados
    const percentualAtrasados = document.getElementById('percentualAtrasados');
    if (percentualAtrasados) {
        const percentual = stats.total_epicos > 0 ? 
            ((stats.epicos_atrasados || 0) / stats.total_epicos * 100).toFixed(1) : 
            '0.0';
        percentualAtrasados.innerHTML = `
            <i class="fas fa-exclamation-triangle me-1"></i>
            ${percentual}%
        `;
    }
}

function showErrorMessage(message) {
    // Criar ou atualizar uma div de erro
    let errorDiv = document.getElementById('dashboard-error');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'dashboard-error';
        errorDiv.className = 'alert alert-danger mt-3';
        document.querySelector('.container-fluid').insertBefore(errorDiv, document.querySelector('.row').nextSibling);
    }
    
    errorDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${message}
        <button type="button" class="btn-close" onclick="document.getElementById('dashboard-error').style.display='none'"></button>
    `;
    errorDiv.style.display = 'block';
}
</script>
{% endblock %}