{% extends "base.html" %}

{% block title %}Dashboard - Sistema de Projetos{% endblock %}
{% block dashboard_active %}active{% endblock %}
{% block page_title %}Dashboard Executivo{% endblock %}

{% block content %}
<div id="periodo-info" class="alert alert-info py-2 mb-3">
    <i class="fas fa-calendar-alt me-2"></i>
    <strong>Período de Análise:</strong> 
    <span id="periodo-texto">Ano Atual</span>
</div>
<!-- Filtros Superiores -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-body bg-light">
                <div class="row align-items-center">
                    <div class="col-md-2">
                        <label for="filterEquipeDash" class="form-label small fw-bold">Equipe</label>
                        <select id="filterEquipeDash" class="form-select form-select-sm">
                            <option value="">Todas as Equipes</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filterProdutoDash" class="form-label small fw-bold">Produto</label>
                        <select id="filterProdutoDash" class="form-select form-select-sm">
                            <option value="">Todos os Produtos</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filterPeriodoDash" class="form-label small fw-bold">Período</label>
                        <select id="filterPeriodoDash" class="form-select form-select-sm">
                            <option value="ano_atual">Ano Atual</option>
                            <option value="6_meses">Últimos 6 Meses</option>
                            <option value="3_meses">Últimos 3 Meses</option>
                            <option value="mes_atual">Mês Atual</option>
                            <option value="todos">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterStatusDash" class="form-label small fw-bold">Status</label>
                        <select id="filterStatusDash" class="form-select form-select-sm">
                            <option value="">Todos os Status</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button id="btnAtualizarDash" class="btn btn-primary btn-sm me-2">
                            <i class="fas fa-sync-alt me-1"></i>
                            Atualizar
                        </button>
                        <button id="btnExportDash" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-download me-1"></i>
                            Exportar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Indicadores Principais -->
<div class="row mb-4">
    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1" style="color: #5a5c69;">
                            Total de Épicos
                        </div>
                        <div class="h4 mb-0 font-weight-bold text-gray-800" id="totalEpicos">
                            {{ stats.total_epicos or 0 }}
                        </div>
                        <div class="mt-2 d-flex align-items-center">
                            <span class="text-success small fw-bold" id="epicosTendencia">
                                <i class="fas fa-arrow-up text-muted me-1"></i>12%
                            </span>
                            <span class="text-muted small ms-1">vs mês anterior</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="icon-circle bg-primary">
                            <i class="fas fa-project-diagram text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1" style="color: #1cc88a;">
                            Taxa de Conclusão
                        </div>
                        <div class="h4 mb-0 font-weight-bold text-gray-800" id="taxaConclusao">
                            {% if stats.total_epicos and stats.total_epicos > 0 %}
                                {{ "%.1f"|format((stats.epicos_concluidos or 0) / stats.total_epicos * 100) }}%
                            {% else %}
                                0.0%
                            {% endif %}
                        </div>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar bg-success" role="progressbar" id="progressConclusao"
                                 style="width: {% if stats.total_epicos and stats.total_epicos > 0 %}{{ (stats.epicos_concluidos or 0) / stats.total_epicos * 100 }}{% else %}0{% endif %}%">
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="icon-circle bg-success">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1" style="color: #36b9cc;">
                            Progresso Médio
                        </div>
                        <div class="h4 mb-0 font-weight-bold text-gray-800" id="progressoMedio">
                            {{ "%.1f"|format(stats.percentual_medio or 0) }}%
                        </div>
                        <div class="mt-2">
                            <span class="badge bg-info" id="statusProgresso">No Prazo</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="icon-circle bg-info">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1" style="color: #f6c23e;">
                            Épicos Atrasados
                        </div>
                        <div class="h4 mb-0 font-weight-bold text-gray-800" id="epicosAtrasados">
                            {{ stats.epicos_atrasados or 0 }}
                        </div>
                        <div class="mt-2">
                            <span class="text-warning small fw-bold" id="percentualAtrasados">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                {% if stats.total_epicos and stats.total_epicos > 0 %}
                                    {{ "%.1f"|format((stats.epicos_atrasados or 0) / stats.total_epicos * 100) }}%
                                {% else %}
                                    0.0%
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="icon-circle bg-warning">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cards de Análise Detalhada -->
<div class="row mb-4">
    <!-- Performance por Equipe -->
    <div class="col-xl-4 col-lg-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-users me-2"></i>Performance por Equipe
                </h6>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportEquipeData()">Exportar Dados</a></li>
                        <li><a class="dropdown-item" href="/relatorio-epicos">Ver Detalhes</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <div id="performanceEquipes" style="height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- Status Distribution -->
    <div class="col-xl-4 col-lg-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-pie me-2"></i>Distribuição por Status
                </h6>
            </div>
            <div class="card-body">
                <div id="statusDistribution" style="height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- Timeline de Entregas -->
    <div class="col-xl-4 col-lg-12 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calendar-alt me-2"></i>Timeline de Entregas
                </h6>
            </div>
            <div class="card-body">
                <div id="timelineEntregas" style=" width: 100%; height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Alertas e Ações -->
<div class="row mb-4">
    <div class="col-xl-8 col-lg-7">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-exclamation-triangle me-2"></i>Alertas e Riscos
                </h6>
            </div>
            <div class="card-body">
                <div id="alertas-container">
                    <!-- Alertas dinâmicos aqui -->
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-lg-5">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-rocket me-2"></i>Ações Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <a href="/gantt" class="btn btn-primary d-flex align-items-center">
                        <i class="fas fa-chart-gantt me-3"></i>
                        <div class="text-start">
                            <div class="fw-bold">Gráfico de Gantt</div>
                            <small class="text-white-50">Visualização de cronograma</small>
                        </div>
                    </a>
                    <a href="/relatorio-epicos" class="btn btn-info d-flex align-items-center">
                        <i class="fas fa-list-alt me-3"></i>
                        <div class="text-start">
                            <div class="fw-bold">Relatório de Épicos</div>
                            <small class="text-white-50">Análise detalhada</small>
                        </div>
                    </a>
                    <a href="/relatorio-subtasks" class="btn btn-success d-flex align-items-center">
                        <i class="fas fa-tasks me-3"></i>
                        <div class="text-start">
                            <div class="fw-bold">Relatório de SubTasks</div>
                            <small class="text-white-50">Controle de atividades</small>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer Info -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-3">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-muted small">
                            <i class="fas fa-sync-alt me-1"></i>
                            Última atualização: <span id="ultimaAtualizacao">Carregando...</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">
                            <i class="fas fa-database me-1"></i>
                            Total de registros: <span id="totalRegistros">{{ (stats.total_epicos or 0) + (stats.total_subtasks or 0) }}</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">
                            <i class="fas fa-clock me-1"></i>
                            Próxima atualização: <span id="proximaAtualizacao">em 5 minutos</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalhes dos Alertas -->
<div class="modal fade" id="modalDetalhesAlerta" tabindex="-1" aria-labelledby="modalDetalhesAlertaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalhesAlertaLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Detalhes do Alerta
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="loadingDetalhes" class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando detalhes...</p>
                </div>
                <div id="conteudoDetalhes" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tabelaDetalhes">
                            <thead class="table-dark">
                                <tr id="cabecalhoTabela">
                                    <!-- Cabeçalho será preenchido dinamicamente -->
                                </tr>
                            </thead>
                            <tbody id="corpoTabela">
                                <!-- Dados serão preenchidos dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                    <div id="resumoDetalhes" class="mt-3 p-3 bg-light rounded">
                        <!-- Resumo será preenchido dinamicamente -->
                    </div>
                </div>
                <div id="erroDetalhes" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Erro ao carregar detalhes. Tente novamente.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="btnExportarDetalhes">
                    <i class="fas fa-download me-1"></i>
                    Exportar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Estilos personalizados -->
<style>
.icon-circle {
    height: 3rem;
    width: 3rem;
    border-radius: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.card {
    transition: transform 0.15s ease-in-out;
    border: none !important;
}

.card:hover {
    transform: translateY(-1px);
}

.bg-gradient-primary {
    background: linear-gradient(180deg, #4e73df 10%, #224abe 100%);
}

.bg-gradient-success {
    background: linear-gradient(180deg, #1cc88a 10%, #13855c 100%);
}

.bg-gradient-info {
    background: linear-gradient(180deg, #36b9cc 10%, #258391 100%);
}

.bg-gradient-warning {
    background: linear-gradient(180deg, #f6c23e 10%, #dda20a 100%);
}

.alert-dashboard {
    border-left: 4px solid;
    border-radius: 0.35rem;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.alert-dashboard:hover {
    background-color: rgba(0,0,0,0.05);
    transform: translateX(2px);
}

.alert-high { border-left-color: #dc3545; }
.alert-medium { border-left-color: #ffc107; }
.alert-low { border-left-color: #17a2b8; }

.text-xs {
    font-size: 0.7rem;
}

.shadow-sm {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
}

#tabelaDetalhes th {
    font-size: 0.875rem;
    font-weight: 600;
}

#tabelaDetalhes td {
    font-size: 0.875rem;
}

.badge-status {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
}

.progress-mini {
    height: 0.5rem;
    border-radius: 0.25rem;
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
// Dados globais
let dashboardData = {
    stats: {{ stats | tojson }},
    equipes: {{ equipes | tojson }},
    timeline: { meses: [], planejado: [], realizado: [] }
};

// Configuração de cores
const colors = {
    primary: '#4e73df',
    success: '#1cc88a',
    info: '#36b9cc',
    warning: '#f6c23e',
    danger: '#e74a3b',
    secondary: '#858796'
};



function setupEventListeners() {
    // Filtros com atualização do período
    document.getElementById('filterEquipeDash').addEventListener('change', applyDashboardFilters);
    document.getElementById('filterProdutoDash').addEventListener('change', applyDashboardFilters);
    document.getElementById('filterPeriodoDash').addEventListener('change', function() {
        updatePeriodLabel();
        applyDashboardFilters();
    });
    document.getElementById('filterStatusDash').addEventListener('change', applyDashboardFilters);
    
    // Botões de ação
    document.getElementById('btnAtualizarDash').addEventListener('click', refreshDashboard);
    document.getElementById('btnExportDash').addEventListener('click', function() {
        window.open('/export/dashboard-completo', '_blank');
    });
}

// Inicialização do Dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando Dashboard...');
    console.log('Dashboard inicializado com dados:', dashboardData);

    // 1. Configurações básicas 
    initializeDashboard();
    generateAlerts();
    updateTimestamp();
    setupEventListeners();


    // 2. GARANTIR loading em todos os gráficos ANTES de qualquer coisa
    console.log('Aplicando loading inicial em todos os gráficos...');
    showLoadingInCharts();

     // 3. Carregar opções de filtros (em paralelo)
    loadFilterOptions();
   
    // 4. Carregar dados principais APÓS um pequeno delay para mostrar loading
    setTimeout(() => {
        loadInitialData();
    }, 500); // 500ms de delay para garantir que loading seja visto
    
    // 5. Configurar timers
    setInterval(refreshDashboard, 300000); // Auto-refresh a cada 5 minutos
    setInterval(updateTimestamp, 60000);   // Atualizar timestamp a cada minuto

    console.log('=== DASHBOARD INICIALIZADO ===');
});

// Mostrar erro nos gráficos
function showErrorInCharts(errorMessage) {
    const charts = [
        { id: 'performanceEquipes', title: 'Performance por Equipe' },
        { id: 'statusDistribution', title: 'Distribuição por Status' },
        { id: 'timelineEntregas', title: 'Timeline de Entregas' }
    ];
    
    charts.forEach(chart => {
        const element = document.getElementById(chart.id);
        if (element) {
            element.innerHTML = `
                <div class="text-center text-danger p-4">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i>
                    <br>
                    <strong>Erro ao carregar</strong>
                    <br>
                    <small class="text-muted">${errorMessage}</small>
                    <br>
                    <button class="btn btn-sm btn-outline-danger mt-2" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Tentar Novamente
                    </button>
                </div>
            `;
        }
    });
}



// ==============================================
// initializeDashboard
// ==============================================
function initializeDashboard() {
    console.log('Dashboard inicializado com dados:', dashboardData);
    
    // Aplicar animações fade-in aos cards
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.classList.add('fade-in');
        }, index * 100);
    });

    updatePeriodLabel();
    atualizarTendenciaEpicos();
    
    // Garantir que timeline também tenha loading inicial
    const timelineElement = document.getElementById('timelineEntregas');
    if (timelineElement && !timelineElement.innerHTML.includes('spinner')) {
        timelineElement.innerHTML = `
            <div class="text-center text-info p-4">
                <div class="spinner-border text-info mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <div>
                    <i class="fas fa-calendar-alt fa-2x mb-2 text-info"></i>
                    <br>
                    <strong>Carregando Timeline...</strong>
                    <br>
                    <small class="text-muted">Processando entregas...</small>
                </div>
            </div>
        `;
    }
}

// ==============================================
// loadInitialData 
// ==============================================

function loadInitialData() {
    console.log('Carregando dados iniciais...');
    
    // Fazer requisição inicial
    fetch('/api/dashboard-data')
        .then(response => {
            console.log('Response inicial:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Dados iniciais recebidos:', data);
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Atualizar dados globais
            if (data.stats) {
                dashboardData.stats = data.stats;
            }
            
            if (data.equipes) {
                dashboardData.equipes = data.equipes;
            }
            
            if (data.timeline && data.timeline.meses && data.timeline.meses.length > 0) {
                dashboardData.timeline = data.timeline;
                console.log('Timeline inicial carregado:', dashboardData.timeline);
            } else {
                console.log('Timeline vazio nos dados iniciais');
                dashboardData.timeline = { meses: [], planejado: [], realizado: [] };
            }
            
            // Atualizar cards
            updateDashboardCards(data.stats || {});
            
            // Criar todos os gráficos (remove o loading automaticamente)
            createCharts();
            
            console.log('Dados iniciais carregados com sucesso');
        })
        .catch(error => {
            console.error('Erro ao carregar dados iniciais:', error);
            
            // Mostrar erro nos gráficos
            showErrorInCharts(`Erro ao carregar dados iniciais: ${error.message}`);
            
            // cria gráficos com dados existentes após um certo tempo
            setTimeout(() => {
                try {
                    console.log('Tentando criar gráficos após erro...');
                    createCharts();
                } catch (chartError) {
                    console.error('Erro ao criar gráficos após falha:', chartError);
                }
            }, 2000);
        });
}



function atualizarTendenciaEpicos() {
    const tendencia = dashboardData.stats?.tendencia_epicos;
    const tendenciaSpan = document.getElementById('epicosTendencia');

    if (!tendenciaSpan) return;

    if (tendencia !== undefined && tendencia !== null) {
        const icone = tendencia > 0 ? 'fa-arrow-up' : (tendencia < 0 ? 'fa-arrow-down' : 'fa-minus');
        const cor = tendencia > 0 ? 'text-success' : (tendencia < 0 ? 'text-danger' : 'text-muted');
        tendenciaSpan.innerHTML = `
            <i class="fas ${icone} me-1"></i>${Math.abs(tendencia).toFixed(1)}%
        `;
        tendenciaSpan.className = `small fw-bold ${cor}`;
    } else {
        tendenciaSpan.innerHTML = `<i class="fas fa-minus me-1"></i>0.0%`;
        tendenciaSpan.className = 'small fw-bold text-muted';
    }
}

function loadFilterOptions() {
    console.log('Carregando opções de filtros...');
    fetch('/api/dashboard-filters')
        .then(response => {
            console.log('Resposta filtros:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dados filtros recebidos:', data);
            if (data.error) {
                console.error('Erro ao carregar filtros:', data.error);
            } else {
                populateFilterSelects(data);
            }
        })
        .catch(error => {
            console.error('Erro na requisição de filtros:', error);
            populateFilterSelects({equipes: [], produtos: [], status: []});
        });
}

function populateFilterSelects(data) {
    console.log('Populando selects com:', data);
    
    // Popular select de equipes
    const equipeSelect = document.getElementById('filterEquipeDash');
    if (equipeSelect && data.equipes) {
        while (equipeSelect.children.length > 1) {
            equipeSelect.removeChild(equipeSelect.lastChild);
        }
        
        data.equipes.forEach(equipe => {
            const option = document.createElement('option');
            option.value = equipe;
            option.textContent = equipe;
            equipeSelect.appendChild(option);
        });
        console.log(`Adicionadas ${data.equipes.length} equipes`);
    }

    // Popular select de produtos
    const produtoSelect = document.getElementById('filterProdutoDash');
    if (produtoSelect && data.produtos) {
        while (produtoSelect.children.length > 1) {
            produtoSelect.removeChild(produtoSelect.lastChild);
        }
        
        data.produtos.forEach(produto => {
            const option = document.createElement('option');
            option.value = produto;
            option.textContent = produto;
            produtoSelect.appendChild(option);
        });
        console.log(`Adicionados ${data.produtos.length} produtos`);
    }

    // Popular select de status (sem multiple)
    const statusSelect = document.getElementById('filterStatusDash');
    if (statusSelect && data.status) {
        while (statusSelect.children.length > 1) {
            statusSelect.removeChild(statusSelect.lastChild);
        }
        
        data.status.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            statusSelect.appendChild(option);
        });
        console.log(`Adicionados ${data.status.length} status`);
    }
}

function createCharts() {
    console.log('=== INICIANDO CRIAÇÃO DE GRÁFICOS ===');
    
    try {
        console.log('1. Criando gráfico de performance...');
        createPerformanceChart();
        
        console.log('2. Criando gráfico de status...');
        createStatusChart();
        
        console.log('3. Criando gráfico de timeline...');
        createTimelineChart();
        
        console.log('=== TODOS OS GRÁFICOS CRIADOS ===');
    } catch (error) {
        console.error('Erro geral na criação de gráficos:', error);
    }
}

function createPerformanceChart() {
    console.log('Criando gráfico de performance...');
    console.log('Dados equipes:', dashboardData.equipes);
    
    // Declarar a variável corretamente
    const performanceElement = document.getElementById('performanceEquipes');
    
    if (!performanceElement) {
        console.error('Elemento performanceEquipes não encontrado');
        return;
    }
    
    // Limpar conteúdo primeiro
    performanceElement.innerHTML = '';
    
    if (!dashboardData.equipes || dashboardData.equipes.length === 0) {
        performanceElement.innerHTML = 
            '<div class="text-center text-muted p-4"><i class="fas fa-chart-bar fa-2x mb-2"></i><br>Sem dados disponíveis</div>';
        return;
    }

    try {
        const data = [{
            x: dashboardData.equipes.map(e => e.EpicEquipe || 'Sem Equipe'),
            y: dashboardData.equipes.map(e => e.quantidade || 0),
            type: 'bar',
            marker: {
                color: dashboardData.equipes.map(e => {
                    const progress = e.percentual_medio || 0;
                    if (progress >= 80) return colors.success;
                    if (progress >= 50) return colors.warning;
                    return colors.danger;
                }),
                opacity: 0.8
            },
            text: dashboardData.equipes.map(e => `${e.quantidade || 0} épicos`),
            textposition: 'auto',
            hovertemplate: '<b>%{x}</b><br>Épicos: %{y}<br>Progresso: %{customdata:.1f}%<extra></extra>',
            customdata: dashboardData.equipes.map(e => e.percentual_medio || 0)
        }];

        const layout = {
            margin: { t: 20, b: 50, l: 50, r: 20 },
            xaxis: { 
                tickangle: -45,
                tickfont: { size: 10 }
            },
            yaxis: { 
                title: 'Quantidade'
            },
            plot_bgcolor: 'rgba(0,0,0,0)',
            paper_bgcolor: 'rgba(0,0,0,0)',
            font: { size: 11 }
        };

        // Usar Plotly.newPlot para garantir criação limpa
        Plotly.newPlot('performanceEquipes', data, layout, {
            responsive: true,
            displayModeBar: false
        });
        
        console.log('Gráfico de performance criado com sucesso');
        
    } catch (error) {
        console.error('Erro ao criar gráfico de performance:', error);
        performanceElement.innerHTML = 
            '<div class="text-center text-danger p-4"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>Erro ao carregar gráfico</div>';
    }
}

function createStatusChart() {
    console.log('Criando gráfico de status...');
    console.log('Dados stats:', dashboardData.stats);
    
    // Declarar a variável corretamente
    const statusElement = document.getElementById('statusDistribution');
    
    if (!statusElement) {
        console.error('Elemento statusDistribution não encontrado');
        return;
    }
    
    // Limpar conteúdo primeiro
    statusElement.innerHTML = '';
    
    if (!dashboardData.stats || dashboardData.stats.error) {
        statusElement.innerHTML = 
            '<div class="text-center text-muted p-4"><i class="fas fa-chart-pie fa-2x mb-2"></i><br>Sem dados disponíveis</div>';
        return;
    }

    const stats = dashboardData.stats;
    const concluidos = stats.epicos_concluidos || 0;
    const emAndamento = stats.epicos_em_andamento || 0;
    const total = stats.total_epicos || 0;
    const outros = Math.max(0, total - concluidos - emAndamento);
    
    if (total === 0) {
        statusElement.innerHTML = 
            '<div class="text-center text-muted p-4"><i class="fas fa-chart-pie fa-2x mb-2"></i><br>Nenhum épico encontrado</div>';
        return;
    }

    try {
        const data = [{
            values: [concluidos, emAndamento, outros],
            labels: ['Concluídos', 'Em Andamento', 'Outros'],
            type: 'pie',
            hole: 0.5,
            marker: {
                colors: [colors.success, colors.info, colors.secondary]
            },
            textinfo: 'label+percent',
            textposition: 'auto',
            hovertemplate: '<b>%{label}</b><br>Quantidade: %{value}<br>Percentual: %{percent}<extra></extra>'
        }];

        const layout = {
            margin: { t: 20, b: 20, l: 20, r: 20 },
            showlegend: false,
            font: { size: 11 }
        };

        // Usar Plotly.newPlot para garantir criação limpa
        Plotly.newPlot('statusDistribution', data, layout, {
            responsive: true,
            displayModeBar: false
        });
        
        console.log('Gráfico de status criado com sucesso');
        
    } catch (error) {
        console.error('Erro ao criar gráfico de status:', error);
        statusElement.innerHTML = 
            '<div class="text-center text-danger p-4"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>Erro ao carregar gráfico</div>';
    }
}

// ==============================================
// createTimelineChart
// ==============================================

function createTimelineChart() {
    console.log('Criando gráfico de timeline...');
    
    // Declarar a variável corretamente
    const timelineElement = document.getElementById('timelineEntregas');
    
    if (!timelineElement) {
        console.error('Elemento timelineEntregas não encontrado');
        return;
    }
    
    //  Limpar o conteúdo primeiro SEMPRE
    console.log('Limpando elemento timeline...');
    timelineElement.innerHTML = '';
    
    // Verificar se existe timeline nos dados globais
    let timeline = dashboardData.timeline;
    
    console.log('Timeline data:', timeline);
    
    // Validação dados timeline
    if (!timeline || !timeline.meses || !Array.isArray(timeline.meses) || timeline.meses.length === 0) {
        console.log('Timeline vazio ou sem dados válidos');
        timelineElement.innerHTML = '<div class="text-center text-muted p-4"><i class="fas fa-calendar-alt fa-2x mb-2"></i><br>Sem dados de entregas</div>';
        return;
    }

    console.log('Dados do timeline encontrados:', {
        meses: timeline.meses,
        planejado: timeline.planejado,
        realizado: timeline.realizado
    });

    try {
        const data = [{
            x: timeline.meses,
            y: timeline.planejado || [],
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Entregas Planejadas',
            line: { color: '#4e73df', width: 3 },
            marker: { size: 8, color: '#4e73df' },
            hovertemplate: '<b>Planejadas</b><br>Mês: %{x}<br>Quantidade: %{y}<extra></extra>'
        }, {
            x: timeline.meses,
            y: timeline.realizado || [],
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Entregas Realizadas',
            line: { color: '#1cc88a', width: 3 },
            marker: { size: 8, color: '#1cc88a' },
            hovertemplate: '<b>Realizadas</b><br>Mês: %{x}<br>Quantidade: %{y}<extra></extra>'
        }];

        const layout = {
            margin: { t: 20, b: 50, l: 50, r: 20 },
            xaxis: { 
                title: 'Mês',
                tickangle: -45,
                type: 'category'
            },
            yaxis: { 
                title: 'Quantidade de Épicos',
                rangemode: 'tozero'
            },
            showlegend: true,
            legend: { 
                orientation: 'h', 
                y: -0.3,
                x: 0.5,
                xanchor: 'center'
            },
            plot_bgcolor: 'rgba(0,0,0,0)',
            paper_bgcolor: 'rgba(0,0,0,0)',
            font: { size: 11 }
        };

        console.log('Criando gráfico Plotly com dados:', data);

        // Usar Plotly.newPlot para garantir criação limpa
        Plotly.newPlot('timelineEntregas', data, layout, {
            responsive: true,
            displayModeBar: false
        });
        
        console.log('Timeline chart criado com sucesso');
        
    } catch (error) {
        console.error('Erro ao criar gráfico timeline:', error);
        timelineElement.innerHTML = '<div class="text-center text-danger p-4"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>Erro ao carregar gráfico</div>';
    }
}

//Função generateAlerts atualizada para usar dados reais
function generateAlerts() {
    const alertsContainer = document.getElementById('alertas-container');
    const stats = dashboardData.stats || {};
    
    // Usar dados reais dos stats, incluindo os novos campos
    const epicosAtrasados = stats.epicos_atrasados || 0;
    const epicosProximoPrazo = stats.epicos_proximo_prazo || 0;
    const epicosBaixoProgresso = stats.epicos_baixo_progresso || 0;
    
    const alerts = [
        {
            type: 'high',
            icon: 'fas fa-exclamation-circle',
            title: 'Épicos Atrasados',
            message: `${epicosAtrasados} épicos estão com prazo vencido`,
            action: 'Ver Detalhes',
            alertType: 'atrasados',
            count: epicosAtrasados
        },
        {
            type: 'medium',
            icon: 'fas fa-clock',
            title: 'Prazo Próximo',
            message: `${epicosProximoPrazo} épicos vencem nos próximos 7 dias`,
            action: 'Verificar',
            alertType: 'proximo_prazo',
            count: epicosProximoPrazo
        },
        {
            type: 'low',
            icon: 'fas fa-info-circle',
            title: 'Baixo Progresso',
            message: `${epicosBaixoProgresso} épicos com progresso inferior a 30%`,
            action: 'Analisar',
            alertType: 'baixo_progresso',
            count: epicosBaixoProgresso
        }
    ];

    if (alertsContainer) {
        alertsContainer.innerHTML = alerts.map(alert => `
            <div class="alert alert-dashboard alert-${alert.type} d-flex align-items-center" onclick="mostrarDetalhesAlerta('${alert.alertType}', '${alert.title}')">
                <div class="flex-shrink-0">
                    <i class="${alert.icon} text-${alert.type === 'high' ? 'danger' : alert.type === 'medium' ? 'warning' : 'info'}"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h6 class="alert-heading mb-1">${alert.title}</h6>
                    <p class="mb-0">${alert.message}</p>
                </div>
                <div class="flex-shrink-0">
                    <button class="btn btn-sm btn-outline-${alert.type === 'high' ? 'danger' : alert.type === 'medium' ? 'warning' : 'info'}">
                        ${alert.action}
                    </button>
                </div>
            </div>
        `).join('');
    }
}

// Função para adicionar label do período
function updatePeriodLabel() {
    const periodoSelect = document.getElementById('filterPeriodoDash');
    const periodoValue = periodoSelect ? periodoSelect.value : 'ano_atual';
    
    // Pegar o elemento que JÁ EXISTE no HTML
    const periodoTexto = document.getElementById('periodo-texto');
    if (!periodoTexto) return; // Se não existir, não faz nada
    
    // Equivalente ao datetime.now() do Python
    const today = new Date();
    
    // Função auxiliar para subtrair dias
    function subtractDays(days) {
        const result = new Date(today);
        result.setDate(result.getDate() - days);
        return result.toLocaleDateString('pt-BR');
    }
    
    // Função auxiliar para formatar data brasileira
    function formatBR(date) {
        return date.toLocaleDateString('pt-BR');
    }
    
    // Definir texto do período
    const periodoTextos = {
        'ano_atual': `01/01/${today.getFullYear()} até 31/12/${today.getFullYear()}`,
        '6_meses': `${subtractDays(180)} até ${formatBR(today)}`,
        '3_meses': `${subtractDays(90)} até ${formatBR(today)}`,
        'mes_atual': (() => {
            const inicioMes = new Date(today.getFullYear(), today.getMonth(), 1);
            const fimMes = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            return `${formatBR(inicioMes)} até ${formatBR(fimMes)}`;
        })(),
        'todos': 'Todos os registros'
    };
    
    // APENAS ATUALIZAR O TEXTO
    periodoTexto.textContent = periodoTextos[periodoValue] || 'Período selecionado';
    
    console.log(`Período atualizado: ${periodoTextos[periodoValue]}`);
}

function mostrarDetalhesAlerta(tipo, titulo) {
    console.log('Mostrando detalhes do alerta:', tipo);
    
    // Configurar o modal
    document.getElementById('modalDetalhesAlertaLabel').innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${titulo}
    `;
    
    // Mostrar loading
    document.getElementById('loadingDetalhes').style.display = 'block';
    document.getElementById('conteudoDetalhes').style.display = 'none';
    document.getElementById('erroDetalhes').style.display = 'none';
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalDetalhesAlerta'));
    modal.show();
    
    // Buscar dados
    fetch(`/api/alertas-detalhes?tipo=${tipo}`)
        .then(response => response.json())
        .then(data => {
            console.log('Dados do alerta recebidos:', data);
            
            if (data.error) {
                document.getElementById('loadingDetalhes').style.display = 'none';
                document.getElementById('erroDetalhes').style.display = 'block';
                document.getElementById('erroDetalhes').innerHTML = `
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Erro: ${data.error}
                `;
            } else {
                mostrarTabelaDetalhes(data, tipo);
            }
        })
        .catch(error => {
            console.error('Erro ao buscar detalhes:', error);
            document.getElementById('loadingDetalhes').style.display = 'none';
            document.getElementById('erroDetalhes').style.display = 'block';
        });
}

function mostrarTabelaDetalhes(data, tipo) {
    document.getElementById('loadingDetalhes').style.display = 'none';
    document.getElementById('conteudoDetalhes').style.display = 'block';
    
    const registros = data.registros || [];
    
    if (registros.length === 0) {
        document.getElementById('conteudoDetalhes').innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5>Nenhum problema encontrado!</h5>
                <p class="text-muted">Não há registros para este tipo de alerta no momento.</p>
            </div>
        `;
        return;
    }
    
    // Configurar cabeçalho da tabela baseado no tipo
    let cabecalho = '';
    if (tipo === 'atrasados') {
        cabecalho = `
            <th>Épico</th>
            <th>Resumo</th>
            <th>Equipe</th>
            <th>Status</th>
            <th>Prazo</th>
            <th>Dias de Atraso</th>
            <th>Progresso</th>
        `;
    } else if (tipo === 'proximo_prazo') {
        cabecalho = `
            <th>Épico</th>
            <th>Resumo</th>
            <th>Equipe</th>
            <th>Status</th>
            <th>Prazo</th>
            <th>Dias Restantes</th>
            <th>Progresso</th>
        `;
    } else if (tipo === 'baixo_progresso') {
        cabecalho = `
            <th>Épico</th>
            <th>Resumo</th>
            <th>Equipe</th>
            <th>Status</th>
            <th>Início</th>
            <th>Dias Decorridos</th>
            <th>Progresso</th>
        `;
    }
    
    document.getElementById('cabecalhoTabela').innerHTML = cabecalho;
    
    // Preencher corpo da tabela
    let corpoHTML = '';
    registros.forEach(registro => {
        let linha = '<tr>';
        
        if (tipo === 'atrasados') {
            linha += `
                <td><strong>${registro.EpicNumber || 'N/A'}</strong></td>
                <td class="text-truncate" style="max-width: 200px;" title="${registro.EpicSummary || ''}">${registro.EpicSummary || 'N/A'}</td>
                <td><span class="badge bg-secondary">${registro.EpicEquipe || 'Sem Equipe'}</span></td>
                <td><span class="badge bg-warning">${registro.EpicStatus || 'N/A'}</span></td>
                <td>${registro.EpicDueDate || 'N/A'}</td>
                <td><span class="badge bg-danger">${registro.DiasAtraso || 0} dias</span></td>
                <td>
                    <div class="progress progress-mini">
                        <div class="progress-bar bg-danger" style="width: ${registro.PercentualConcluido || 0}%"></div>
                    </div>
                    <small>${registro.PercentualConcluido || 0}%</small>
                </td>
            `;
        } else if (tipo === 'proximo_prazo') {
            linha += `
                <td><strong>${registro.EpicNumber || 'N/A'}</strong></td>
                <td class="text-truncate" style="max-width: 200px;" title="${registro.EpicSummary || ''}">${registro.EpicSummary || 'N/A'}</td>
                <td><span class="badge bg-secondary">${registro.EpicEquipe || 'Sem Equipe'}</span></td>
                <td><span class="badge bg-info">${registro.EpicStatus || 'N/A'}</span></td>
                <td>${registro.EpicDueDate || 'N/A'}</td>
                <td><span class="badge bg-warning">${registro.DiasRestantes || 0} dias</span></td>
                <td>
                    <div class="progress progress-mini">
                        <div class="progress-bar bg-warning" style="width: ${registro.PercentualConcluido || 0}%"></div>
                    </div>
                    <small>${registro.PercentualConcluido || 0}%</small>
                </td>
            `;
        } else if (tipo === 'baixo_progresso') {
            linha += `
                <td><strong>${registro.EpicNumber || 'N/A'}</strong></td>
                <td class="text-truncate" style="max-width: 200px;" title="${registro.EpicSummary || ''}">${registro.EpicSummary || 'N/A'}</td>
                <td><span class="badge bg-secondary">${registro.EpicEquipe || 'Sem Equipe'}</span></td>
                <td><span class="badge bg-info">${registro.EpicStatus || 'N/A'}</span></td>
                <td>${registro.EpicInicioPlanejado || 'N/A'}</td>
                <td><span class="badge bg-info">${registro.DiasDecorridos || 0} dias</span></td>
                <td>
                    <div class="progress progress-mini">
                        <div class="progress-bar bg-danger" style="width: ${registro.PercentualConcluido || 0}%"></div>
                    </div>
                    <small>${registro.PercentualConcluido || 0}%</small>
                </td>
            `;
        }
        
        linha += '</tr>';
        corpoHTML += linha;
    });
    
    document.getElementById('corpoTabela').innerHTML = corpoHTML;
    
    // Mostrar resumo
    const resumo = `
        <h6><i class="fas fa-chart-bar me-2"></i>Resumo</h6>
        <div class="row">
            <div class="col-md-4">
                <strong>Total de registros:</strong> ${registros.length}
            </div>
            <div class="col-md-4">
                <strong>Tipo de alerta:</strong> ${tipo.replace('_', ' ').toUpperCase()}
            </div>
            <div class="col-md-4">
                <strong>Gerado em:</strong> ${new Date().toLocaleString('pt-BR')}
            </div>
        </div>
    `;
    
    document.getElementById('resumoDetalhes').innerHTML = resumo;
    
    // Configurar botão de exportar
    document.getElementById('btnExportarDetalhes').onclick = function() {
        exportarDetalhes(tipo, registros);
    };
}

function exportarDetalhes(tipo, registros) {
    // Converter para CSV e fazer download
    if (registros.length === 0) return;
    
    const headers = Object.keys(registros[0]);
    let csvContent = headers.join(',') + '\n';
    
    registros.forEach(registro => {
        const row = headers.map(header => {
            const value = registro[header] || '';
            return `"${value.toString().replace(/"/g, '""')}"`;
        }).join(',');
        csvContent += row + '\n';
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `alerta_${tipo}_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function updateTimestamp() {
    const now = new Date();
    const timestamp = now.toLocaleString('pt-BR', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    document.getElementById('ultimaAtualizacao').textContent = timestamp;
    
    const proxima = new Date(now.getTime() + 5 * 60 * 1000);
    document.getElementById('proximaAtualizacao').textContent = 
        'às ' + proxima.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}


// ==============================================
// refreshDashboard
// ==============================================

function refreshDashboard() {
    console.log('Atualizando dashboard...');
    
    // Mostrar loading de refresh
    showRefreshLoading();
    
    // Verificar se os elementos existem antes de acessar .value
    let equipe = '';
    let produto = '';
    let periodo = 'ano_atual'; // valor padrão
    let status = '';
    
    try {
        const equipeElement = document.getElementById('filterEquipeDash');
        const produtoElement = document.getElementById('filterProdutoDash');
        const periodoElement = document.getElementById('filterPeriodoDash');
        const statusElement = document.getElementById('filterStatusDash');
        
        if (equipeElement) equipe = equipeElement.value || '';
        if (produtoElement) produto = produtoElement.value || '';
        if (periodoElement) periodo = periodoElement.value || 'ano_atual';
        if (statusElement) status = statusElement.value || '';
        
        console.log('Filtros obtidos:', { equipe, produto, periodo, status });
        
    } catch (error) {
        console.error('Erro ao obter valores dos filtros:', error);
        // Usar valores padrão em caso de erro
        equipe = '';
        produto = '';
        periodo = 'ano_atual';
        status = '';
    }

    const params = new URLSearchParams({ equipe, produto, periodo, status });

    fetch(`/api/dashboard-data?${params.toString()}`)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Dashboard atualizado:', data);
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Atualizar dados globais
            dashboardData.stats = data.stats || {};
            dashboardData.equipes = data.equipes || [];
            dashboardData.timeline = data.timeline || { meses: [], planejado: [], realizado: [] };
            
            // Atualizar interface
            updateDashboardCards(data.stats || {});
            createCharts();
            generateAlerts();
            updateTimestamp();
            
            console.log('Dashboard refresh completo');
        })
        .catch(error => {
            console.error('Erro ao atualizar dashboard:', error);
            showErrorInCharts(`Erro ao atualizar: ${error.message}`);
            
            // Tentar criar gráficos com dados existentes após erro
            setTimeout(() => {
                try {
                    createCharts();
                } catch (chartError) {
                    console.error('Erro ao criar gráficos após falha:', chartError);
                }
            }, 1000);
        });
}

// Loading específico para refresh
function showRefreshLoading() {
    console.log('Mostrando loading de refresh...');
    
    // Loading nos cards
    showLoadingInCards();
    
    // Loading específico para refresh nos gráficos
    const charts = [
        { id: 'performanceEquipes', title: 'Performance por Equipe', icon: 'fa-chart-bar' },
        { id: 'statusDistribution', title: 'Distribuição por Status', icon: 'fa-chart-pie' },
        { id: 'timelineEntregas', title: 'Timeline de Entregas', icon: 'fa-calendar-alt' }
    ];
    
    charts.forEach(chart => {
        const element = document.getElementById(chart.id);
        if (element) {
         //   console.log(`Aplicando refresh loading em: ${chart.id}`);
         //   console.log(`Título: ${chart.title}, Ícone: ${chart.icon}`);
        //    console.log(`icone:`, chart.icon);
            element.innerHTML = `
                <div class="text-center text-muted p-4">
                    <div class="spinner-border text-primary  mb-3" role="status" style="width: 2.5rem; height: 2.5rem;">
                        <span class="visually-hidden">Atualizando...</span>
                    </div>
                    <div>
                        <i class="fas ${chart.icon} fa-2x mb-2 text-muted"></i>
                        <br>
                        <strong>Atualizando dados...</strong>
                        <br>
                        <small class="text-muted">Sincronizando ${chart.title}</small>
                    </div>
                </div>
            `;
        } else {
            console.warn(`Elemento ${chart.id} não encontrado para refresh loading`);
        }
    });
}

function exportEquipeData() {
    window.open('/export/dashboard-equipes', '_blank');
}

// Event Listeners
document.getElementById('btnAtualizarDash').addEventListener('click', refreshDashboard);
document.getElementById('btnExportDash').addEventListener('click', function() {
    window.open('/export/dashboard-completo', '_blank');
});

// Filtros
document.getElementById('filterEquipeDash').addEventListener('change', applyDashboardFilters);
document.getElementById('filterProdutoDash').addEventListener('change', applyDashboardFilters);
document.getElementById('filterPeriodoDash').addEventListener('change', applyDashboardFilters);
document.getElementById('filterStatusDash').addEventListener('change', applyDashboardFilters);


function applyDashboardFilters() {
    console.log('Aplicando filtros do dashboard...');
    

    showFilterLoading();
    
    const equipe = document.getElementById('filterEquipeDash').value;
    const produto = document.getElementById('filterProdutoDash').value;
    const periodo = document.getElementById('filterPeriodoDash').value;
    const status = document.getElementById('filterStatusDash').value;
    
    console.log('Filtros selecionados:', { equipe, produto, periodo, status });
    
    const params = new URLSearchParams({
        equipe: equipe,
        produto: produto,
        periodo: periodo,
        status: status
    });
    
    fetch(`/api/dashboard-data?${params.toString()}`)
        .then(response => {
            console.log('Resposta dashboard-data:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dados dashboard recebidos:', data);
            
            if (data.error) {
                console.error('Erro nos dados:', data.error);
                hideLoadingInCards();
                showErrorMessage('Erro ao carregar dados: ' + data.error);
            } else {
                // Atualizar todos os dados globais
                dashboardData.stats = data.stats || {};
                dashboardData.equipes = data.equipes || [];
                
                //  Validar e atualizar timeline
                if (data.timeline && data.timeline.meses && Array.isArray(data.timeline.meses)) {
                    console.log('Timeline recebido nos filtros:', data.timeline);
                    dashboardData.timeline = data.timeline;
                } else {
                    console.log('Timeline vazio nos filtros, mantendo dados anteriores ou vazios');
                    if (!dashboardData.timeline || !dashboardData.timeline.meses) {
                        dashboardData.timeline = { meses: [], planejado: [], realizado: [] };
                    }
                }
                
                // Atualizar cards primeiro
                updateDashboardCards(data.stats);
                
                // Criar gráficos diretamente
                createCharts();
              
                // Gerar alertas
                generateAlerts();
                
                hideLoadingInCards();
                
                console.log('Dashboard atualizado com sucesso');
            }
        })
        .catch(error => {
            console.error('Erro na requisição dashboard-data:', error);
            hideLoadingInCards();
            showErrorMessage('Erro ao conectar com o servidor');
        });
}

function showFilterLoading() {
    console.log('Aplicando filtros - mostrando loading...');
    
    // Mostrar loading nos cards de números
    showLoadingInCards();
    
    // Mostrar mensagem específica de filtros nos gráficos
    const charts = [
        { id: 'performanceEquipes', title: 'Performance por Equipe' },
        { id: 'statusDistribution', title: 'Distribuição por Status' },
        { id: 'timelineEntregas', title: 'Timeline de Entregas' }
    ];
    
    charts.forEach(chart => {
        const element = document.getElementById(chart.id);
        if (element) {
            element.innerHTML = `
                <div class="text-center text-primary p-4">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 2.5rem; height: 2.5rem;">
                        <span class="visually-hidden">Aplicando filtros...</span>
                    </div>
                    <div>
                        <i class="fas fa-filter fa-2x mb-2 text-primary"></i>
                        <br>
                        <strong>Aplicando filtros...</strong>
                        <br>
                        <small class="text-muted">Atualizando ${chart.title}</small>
                    </div>
                </div>
            `;
        }
    });
}

function showLoadingInCards() {
    console.log('Mostrando loading nos cards...');
    const cards = ['totalEpicos', 'taxaConclusao', 'progressoMedio', 'epicosAtrasados'];
    cards.forEach(cardId => {
        const element = document.getElementById(cardId);
        if (element) {
            element.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
    });
} 

function showLoadingInCharts() {
    console.log('Mostrando loading nos gráficos...');
    
    const charts = [
        { id: 'performanceEquipes', title: 'Performance por Equipe', icon: 'fa-chart-bar' },
        { id: 'statusDistribution', title: 'Distribuição por Status', icon: 'fa-chart-pie' },
        { id: 'timelineEntregas', title: 'Timeline de Entregas', icon: 'fa-calendar-alt' }
    ];
    
    charts.forEach(chart => {
        const element = document.getElementById(chart.id);
        if (element) {
            console.log(`Aplicando loading em: ${chart.id}`);
            element.innerHTML = `
                <div class="text-center text-muted p-4">
                    <div class="spinner-border text-primary font-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <div>
                        <i class="fas ${chart.icon} fa-2x mb-2 text-muted"></i>
                        <br>
                        <strong>Carregando ${chart.title}...</strong>
                        <br>
                        <small class="text-muted">Processando dados...</small>
                    </div>
                </div>
            `;
        } else {
            console.warn(`Elemento ${chart.id} não encontrado para loading`);
        }
    });
}

function hideLoadingInCards() {
    console.log('Loading nos cards removido automaticamente por updateDashboardCards()');
    // O loading será removido quando updateDashboardCards() for chamada
}

function updateDashboardCards(stats) {
    console.log('Atualizando cards com:', stats);
    
    // Atualizar Total de Épicos
    const totalEpicos = document.getElementById('totalEpicos');
    if (totalEpicos) {
        totalEpicos.textContent = stats.total_epicos || 0;
    }
    
    // 
    const tendencia = dashboardData.stats?.tendencia_epicos;
    const tendenciaSpan = document.getElementById('epicosTendencia');

    if (tendencia !== undefined && tendencia !== null) {
        const icone = tendencia > 0 ? 'fa-arrow-up' : tendencia < 0 ? 'fa-arrow-down' : 'fa-minus';
        const cor = tendencia > 0 ? 'text-success' : tendencia < 0 ? 'text-danger' : 'text-muted';

        tendenciaSpan.innerHTML = `
            <i class="fas ${icone} me-1"></i>${Math.abs(tendencia).toFixed(1)}%
        `;
        tendenciaSpan.className = `small fw-bold ${cor}`;
    } else {
        tendenciaSpan.innerHTML = `<i class="fas fa-minus me-1"></i>0%`;
        tendenciaSpan.className = 'text-muted small fw-bold';
    }
        
    // Atualizar Taxa de Conclusão
    const taxaConclusao = document.getElementById('taxaConclusao');
    const progressConclusao = document.getElementById('progressConclusao');
    if (taxaConclusao) {
        const taxa = stats.total_epicos > 0 ? 
            ((stats.epicos_concluidos || 0) / stats.total_epicos * 100).toFixed(1) : 
            '0.0';
        taxaConclusao.textContent = taxa + '%';
        
        if (progressConclusao) {
            progressConclusao.style.width = taxa + '%';
        }
    }
    
    // Atualizar Progresso Médio
    const progressoMedio = document.getElementById('progressoMedio');
    if (progressoMedio) {
        const progresso = (stats.percentual_medio || 0).toFixed(1);
        progressoMedio.textContent = progresso + '%';
        
        // Atualizar badge de status
        const statusProgresso = document.getElementById('statusProgresso');
        if (statusProgresso) {
            if (progresso >= 80) {
                statusProgresso.className = 'badge bg-success';
                statusProgresso.textContent = 'Excelente';
            } else if (progresso >= 60) {
                statusProgresso.className = 'badge bg-info';
                statusProgresso.textContent = 'No Prazo';
            } else if (progresso >= 40) {
                statusProgresso.className = 'badge bg-warning';
                statusProgresso.textContent = 'Atenção';
            } else {
                statusProgresso.className = 'badge bg-danger';
                statusProgresso.textContent = 'Crítico';
            }
        }
    }
    
    // Atualizar Épicos Atrasados
    const epicosAtrasados = document.getElementById('epicosAtrasados');
    if (epicosAtrasados) {
        epicosAtrasados.textContent = stats.epicos_atrasados || 0;
    }
    
    // Atualizar percentual de atrasados
    const percentualAtrasados = document.getElementById('percentualAtrasados');
    if (percentualAtrasados) {
        const percentual = stats.total_epicos > 0 ? 
            ((stats.epicos_atrasados || 0) / stats.total_epicos * 100).toFixed(1) : 
            '0.0';
        percentualAtrasados.innerHTML = `
            <i class="fas fa-exclamation-triangle me-1"></i>
            ${percentual}%
        `;
    }
    
    // Atualizar total de registros no footer
    const totalRegistros = document.getElementById('totalRegistros');
    if (totalRegistros) {
        totalRegistros.textContent = (stats.total_epicos || 0) + (stats.total_subtasks || 0);
    }
    
    // Atualizar período label
    updatePeriodLabel();
}

// Função para obter filtros atuais
function getCurrentFilters() {
    return {
        equipe: document.getElementById('filterEquipeDash').value,
        produto: document.getElementById('filterProdutoDash').value,
        periodo: document.getElementById('filterPeriodoDash').value,
        status: document.getElementById('filterStatusDash').value
    };
}

//Adicionar event listener para mudança de período
function setupEventListeners() {
    // Filtros existentes
    document.getElementById('filterEquipeDash').addEventListener('change', applyDashboardFilters);
    document.getElementById('filterProdutoDash').addEventListener('change', applyDashboardFilters);
    document.getElementById('filterPeriodoDash').addEventListener('change', function() {
        updatePeriodLabel();
        applyDashboardFilters();
    });
    document.getElementById('filterStatusDash').addEventListener('change', applyDashboardFilters);
     
    // Botões de ação
    document.getElementById('btnAtualizarDash').addEventListener('click', refreshDashboard);
    document.getElementById('btnExportDash').addEventListener('click', function() {
        window.open('/export/dashboard-completo', '_blank');
    });
}

function showErrorMessage(message) {
    let errorDiv = document.getElementById('dashboard-error');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'dashboard-error';
        errorDiv.className = 'alert alert-danger alert-dismissible mt-3';
        document.querySelector('.container-fluid').insertBefore(errorDiv, document.querySelector('.row'));
    }
    
    errorDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    errorDiv.style.display = 'block';
    
    // Auto-hide após 5 segundos
    setTimeout(() => {
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
    }, 5000);
}
</script>
{% endblock %}