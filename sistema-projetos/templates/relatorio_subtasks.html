{% extends "base.html" %}

{% block title %}Relatório de SubTasks - Sistema de Projetos{% endblock %}
{% block subtasks_active %}active{% endblock %}
{% block page_title %}Relatório de SubTasks{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tasks me-2"></i>
                    Dados das SubTasks
                </h5>
                <div>
                    <button id="btnExportCSVSubtasks" class="btn btn-success btn-export">
                        <i class="fas fa-file-csv me-2"></i>
                        Exportar CSV Filtrado
                    </button>
                    <button id="btnRefreshSubtasks" class="btn btn-primary">
                        <i class="fas fa-sync-alt me-2"></i>
                        Atualizar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Filtros Melhorados -->
                <div class="filter-section bg-light p-3 rounded mb-4">
                    <h6 class="mb-3">
                        <i class="fas fa-filter me-2"></i>
                        Filtros
                    </h6>
                    
                    <!-- Linha 1: Filtros básicos -->
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <label for="filterEquipeSubtasks" class="form-label">Equipe</label>
                            <select id="filterEquipeSubtasks" class="form-select">
                                <option value="">Todas as Equipes</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterStatusSubtasks" class="form-label">Status</label>
                            <select id="filterStatusSubtasks" class="form-select">
                                <option value="">Todos os Status</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="filterTipoSubtasks" class="form-label">Tipo</label>
                            <select id="filterTipoSubtasks" class="form-select">
                                <option value="">Todos os Tipos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterDataInicioSubtasks" class="form-label">Data Início</label>
                            <input type="date" id="filterDataInicioSubtasks" class="form-control" value="">
                        </div>
                        <div class="col-md-3">
                            <label for="filterDataFimSubtasks" class="form-label">Data Fim</label>
                            <input type="date" id="filterDataFimSubtasks" class="form-control" value="">
                        </div>
                    </div>
                    
                    <!-- Linha 2: Mais filtros e busca -->
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <label for="filterEtapaSubtasks" class="form-label">Etapa</label>
                            <select id="filterEtapaSubtasks" class="form-select">
                                <option value="">Todas as Etapas</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="searchSubtasks" class="form-label">Buscar</label>
                            <input type="text" id="searchSubtasks" class="form-control" placeholder="Buscar por número ou resumo...">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button type="button" id="btnAnoAtualSubtasks" class="btn btn-info me-2">
                                <i class="fas fa-calendar me-1"></i>
                                Ano Atual
                            </button>
                            <button type="button" id="btnUltimos6MesesSubtasks" class="btn btn-warning me-2">
                                <i class="fas fa-calendar-alt me-1"></i>
                                Últimos 6 Meses
                            </button>
                            <button type="button" id="btnLimparFiltrosSubtasks" class="btn btn-secondary me-2">
                                <i class="fas fa-times me-1"></i>
                                Limpar Filtros
                            </button>
                            <span id="totalRegistrosSubtasks" class="badge bg-primary ms-3 fs-6">0 registros</span>
                        </div>
                    </div>
                </div>

                <!-- Loading -->
                <div id="loadingSubtasks" class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando dados das subtasks...</p>
                </div>

                <!-- Erro -->
                <div id="errorSubtasks" style="display: none;" class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessageSubtasks"></span>
                </div>

                <!-- Tabela -->
                <div id="tableContainerSubtasks" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tableSubtasks">
                            <thead class="table-dark">
                                <tr>
                                    <th>Número</th>
                                    <th>Resumo</th>
                                    <th>Equipe</th>
                                    <th>Tipo</th>
                                    <th>Etapa</th>
                                    <th>Status</th>
                                    <th>Responsável</th>
                                    <th>Início Planejado</th>
                                    <th>Fim Planejado</th>
                                    <th>% Concluído</th>
                                    <th>Épico</th>
                                </tr>
                            </thead>
                            <tbody id="tbodySubtasks">
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginação -->
                    <nav aria-label="Paginação">
                        <ul class="pagination justify-content-center" id="paginationSubtasks">
                        </ul>
                    </nav>

                    <!-- Info da tabela -->
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                Mostrando <span id="showingFromSubtasks">0</span> a <span id="showingToSubtasks">0</span> 
                                de <span id="totalRecordsSubtasks">0</span> registros
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <label for="pageSizeSubtasks" class="form-label me-2">Registros por página:</label>
                            <select id="pageSizeSubtasks" class="form-select d-inline-block w-auto">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let subtasksData = [];
let filteredSubtasksData = [];
let currentPageSubtasks = 1;
let pageSizeSubtasks = 25;

// Inicializar datas padrão (ano atual)
function initializeDefaultDatesSubtasks() {
    const currentYear = new Date().getFullYear();
    document.getElementById('filterDataInicioSubtasks').value = `${currentYear}-01-01`;
    document.getElementById('filterDataFimSubtasks').value = `${currentYear}-12-31`;
}

function loadSubtasksData() {
    fetch('/api/subtasks-data')
        .then(response => response.json())
        .then(data => {
            document.getElementById('loadingSubtasks').style.display = 'none';
            
            if (data.error) {
                showErrorSubtasks(data.error);
            } else {
                subtasksData = data;
                applyFiltersSubtasks(); // Aplicar filtros após carregar
                populateFiltersSubtasks();
                document.getElementById('tableContainerSubtasks').style.display = 'block';
            }
        })
        .catch(error => {
            document.getElementById('loadingSubtasks').style.display = 'none';
            showErrorSubtasks('Erro ao carregar dados: ' + error.message);
        });
}

function populateFiltersSubtasks() {
    const equipeSelect = document.getElementById('filterEquipeSubtasks');
    const equipes = [...new Set(subtasksData.map(item => item.TaskEquipe).filter(e => e))];
    equipes.sort().forEach(equipe => {
        const option = document.createElement('option');
        option.value = equipe;
        option.textContent = equipe;
        equipeSelect.appendChild(option);
    });

    const statusSelect = document.getElementById('filterStatusSubtasks');
    const statuses = [...new Set(subtasksData.map(item => item.TaskStatus).filter(s => s))];
    statuses.sort().forEach(status => {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        statusSelect.appendChild(option);
    });

    const tipoSelect = document.getElementById('filterTipoSubtasks');
    const tipos = [...new Set(subtasksData.map(item => item.TaskType).filter(t => t))];
    tipos.sort().forEach(tipo => {
        const option = document.createElement('option');
        option.value = tipo;
        option.textContent = tipo;
        tipoSelect.appendChild(option);
    });

    const etapaSelect = document.getElementById('filterEtapaSubtasks');
    const etapas = [...new Set(subtasksData.map(item => item.TaskEtapa).filter(e => e))];
    etapas.sort().forEach(etapa => {
        const option = document.createElement('option');
        option.value = etapa;
        option.textContent = etapa;
        etapaSelect.appendChild(option);
    });
}

function applyFiltersSubtasks() {
    const equipeFilter = document.getElementById('filterEquipeSubtasks').value;
    const statusFilter = document.getElementById('filterStatusSubtasks').value;
    const tipoFilter = document.getElementById('filterTipoSubtasks').value;
    const etapaFilter = document.getElementById('filterEtapaSubtasks').value;
    const searchFilter = document.getElementById('searchSubtasks').value.toLowerCase();
    const dataInicio = document.getElementById('filterDataInicioSubtasks').value;
    const dataFim = document.getElementById('filterDataFimSubtasks').value;

    filteredSubtasksData = subtasksData.filter(item => {
        // Filtros básicos
        let matches = (!equipeFilter || item.TaskEquipe === equipeFilter) &&
                     (!statusFilter || item.TaskStatus === statusFilter) &&
                     (!tipoFilter || item.TaskType === tipoFilter) &&
                     (!etapaFilter || item.TaskEtapa === etapaFilter) &&
                     (!searchFilter || 
                      (item.TaskNumberId && item.TaskNumberId.toLowerCase().includes(searchFilter)) ||
                      (item.TaskSummary && item.TaskSummary.toLowerCase().includes(searchFilter)));

        // Filtro de data (verificar se a subtask está no período)
        if (matches && (dataInicio || dataFim)) {
            const taskInicio = item.TaskInicioPlanejado ? parseDate(item.TaskInicioPlanejado) : null;
            const taskFim = item.TaskFimPlanejado ? parseDate(item.TaskFimPlanejado) : null;
            
            if (dataInicio && dataFim) {
                const filterStart = new Date(dataInicio);
                const filterEnd = new Date(dataFim);
                
                // Subtask deve ter alguma sobreposição com o período filtrado
                if (taskInicio && taskFim) {
                    matches = matches && (
                        (taskFim >= filterStart && taskFim <= filterEnd) ||
                        (taskInicio >= filterStart && taskInicio <= filterEnd) ||
                        (taskInicio < filterStart && taskFim > filterEnd)
                    );
                } else if (taskInicio) {
                    matches = matches && (taskInicio >= filterStart && taskInicio <= filterEnd);
                } else if (taskFim) {
                    matches = matches && (taskFim >= filterStart && taskFim <= filterEnd);
                }
            }
        }

        return matches;
    });

    currentPageSubtasks = 1;
    renderTableSubtasks();
    updateTotalRegistrosSubtasks();
}

function parseDate(dateString) {
    // Converter formato brasileiro DD/MM/YYYY HH:MM para Date
    if (!dateString) return null;
    
    // Se já está no formato ISO
    if (dateString.includes('-')) {
        return new Date(dateString);
    }
    
    // Se está no formato brasileiro
    const parts = dateString.split(' ')[0].split('/');
    if (parts.length === 3) {
        return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    
    return new Date(dateString);
}

function renderTableSubtasks() {
    const tbody = document.getElementById('tbodySubtasks');
    const startIndex = (currentPageSubtasks - 1) * pageSizeSubtasks;
    const endIndex = Math.min(startIndex + pageSizeSubtasks, filteredSubtasksData.length);
    const pageData = filteredSubtasksData.slice(startIndex, endIndex);

    tbody.innerHTML = '';

    pageData.forEach(item => {
        const row = document.createElement('tr');
        
        const formatPercentual = (value) => {
            if (!value) return '0%';
            return parseFloat(value).toFixed(1) + '%';
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return '-';
            return dateStr;
        };

        const getStatusClass = (status) => {
            switch(status) {
                case 'Done': return 'badge bg-success';
                case 'In Progress': return 'badge bg-primary';
                case 'Development': return 'badge bg-info';
                case 'To Do': return 'badge bg-secondary';
                case 'Ready': return 'badge bg-warning text-dark';
                default: return 'badge bg-light text-dark';
            }
        };

        row.innerHTML = `
            <td>${item.TaskNumberId || '-'}</td>
            <td title="${item.TaskSummary || ''}">
                ${item.TaskSummary ? (item.TaskSummary.length > 40 ? item.TaskSummary.substring(0, 40) + '...' : item.TaskSummary) : '-'}
            </td>
            <td>${item.TaskEquipe || '-'}</td>
            <td>${item.TaskType || '-'}</td>
            <td>${item.TaskEtapa || '-'}</td>
            <td><span class="${getStatusClass(item.TaskStatus)}">${item.TaskStatus || '-'}</span></td>
            <td>${item.TaskAssignee || '-'}</td>
            <td>${formatDate(item.TaskInicioPlanejado)}</td>
            <td>${formatDate(item.TaskFimPlanejado)}</td>
            <td>
                <div class="progress" style="height: 20px; width: 80px;">
                    <div class="progress-bar" role="progressbar" 
                         style="width: ${item.TaskPercentualConcluido || 0}%"
                         aria-valuenow="${item.TaskPercentualConcluido || 0}" 
                         aria-valuemin="0" aria-valuemax="100">
                        ${formatPercentual(item.TaskPercentualConcluido)}
                    </div>
                </div>
            </td>
            <td title="${item.EpicSummary || ''}">
                ${item.EpicNumber ? item.EpicNumber : '-'}
            </td>
        `;
        
        tbody.appendChild(row);
    });

    renderPaginationSubtasks();
    updateTableInfoSubtasks();
}

function renderPaginationSubtasks() {
    const pagination = document.getElementById('paginationSubtasks');
    const totalPages = Math.ceil(filteredSubtasksData.length / pageSizeSubtasks);
    
    pagination.innerHTML = '';

    if (totalPages <= 1) return;

    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPageSubtasks === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePageSubtasks(${currentPageSubtasks - 1})">Anterior</a>`;
    pagination.appendChild(prevLi);

    const startPage = Math.max(1, currentPageSubtasks - 2);
    const endPage = Math.min(totalPages, currentPageSubtasks + 2);

    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPageSubtasks ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePageSubtasks(${i})">${i}</a>`;
        pagination.appendChild(li);
    }

    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPageSubtasks === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePageSubtasks(${currentPageSubtasks + 1})">Próximo</a>`;
    pagination.appendChild(nextLi);
}

function changePageSubtasks(page) {
    const totalPages = Math.ceil(filteredSubtasksData.length / pageSizeSubtasks);
    if (page >= 1 && page <= totalPages) {
        currentPageSubtasks = page;
        renderTableSubtasks();
    }
}

function updateTableInfoSubtasks() {
    const startIndex = (currentPageSubtasks - 1) * pageSizeSubtasks + 1;
    const endIndex = Math.min(currentPageSubtasks * pageSizeSubtasks, filteredSubtasksData.length);
    
    document.getElementById('showingFromSubtasks').textContent = filteredSubtasksData.length > 0 ? startIndex : 0;
    document.getElementById('showingToSubtasks').textContent = endIndex;
    document.getElementById('totalRecordsSubtasks').textContent = filteredSubtasksData.length;
}

function updateTotalRegistrosSubtasks() {
    document.getElementById('totalRegistrosSubtasks').textContent = `${filteredSubtasksData.length} registros`;
}

function showErrorSubtasks(message) {
    document.getElementById('errorMessageSubtasks').textContent = message;
    document.getElementById('errorSubtasks').style.display = 'block';
}

function setCurrentYearSubtasks() {
    const currentYear = new Date().getFullYear();
    document.getElementById('filterDataInicioSubtasks').value = `${currentYear}-01-01`;
    document.getElementById('filterDataFimSubtasks').value = `${currentYear}-12-31`;
    applyFiltersSubtasks();
}

function setLast6MonthsSubtasks() {
    const hoje = new Date();
    const seisMesesAtras = new Date();
    seisMesesAtras.setMonth(hoje.getMonth() - 6);
    
    const dataInicio = seisMesesAtras.toISOString().split('T')[0];
    const dataFim = hoje.toISOString().split('T')[0];
    
    document.getElementById('filterDataInicioSubtasks').value = dataInicio;
    document.getElementById('filterDataFimSubtasks').value = dataFim;
    applyFiltersSubtasks();
}

function clearFiltersSubtasks() {
    document.getElementById('filterEquipeSubtasks').value = '';
    document.getElementById('filterStatusSubtasks').value = '';
    document.getElementById('filterTipoSubtasks').value = '';
    document.getElementById('filterEtapaSubtasks').value = '';
    document.getElementById('searchSubtasks').value = '';
    document.getElementById('filterDataInicioSubtasks').value = '';
    document.getElementById('filterDataFimSubtasks').value = '';
    applyFiltersSubtasks();
}

function exportFilteredCSVSubtasks() {
    // Obter parâmetros dos filtros atuais
    const params = new URLSearchParams({
        equipe: document.getElementById('filterEquipeSubtasks').value,
        status: document.getElementById('filterStatusSubtasks').value,
        tipo: document.getElementById('filterTipoSubtasks').value,
        etapa: document.getElementById('filterEtapaSubtasks').value,
        search: document.getElementById('searchSubtasks').value,
        data_inicio: document.getElementById('filterDataInicioSubtasks').value,
        data_fim: document.getElementById('filterDataFimSubtasks').value
    });
    
    // Abrir URL de export com filtros
    window.open(`/export/subtasks?${params.toString()}`, '_blank');
}

// Event Listeners
document.getElementById('filterEquipeSubtasks').addEventListener('change', applyFiltersSubtasks);
document.getElementById('filterStatusSubtasks').addEventListener('change', applyFiltersSubtasks);
document.getElementById('filterTipoSubtasks').addEventListener('change', applyFiltersSubtasks);
document.getElementById('filterEtapaSubtasks').addEventListener('change', applyFiltersSubtasks);
document.getElementById('searchSubtasks').addEventListener('input', applyFiltersSubtasks);
document.getElementById('filterDataInicioSubtasks').addEventListener('change', applyFiltersSubtasks);
document.getElementById('filterDataFimSubtasks').addEventListener('change', applyFiltersSubtasks);

document.getElementById('btnAnoAtualSubtasks').addEventListener('click', setCurrentYearSubtasks);
document.getElementById('btnUltimos6MesesSubtasks').addEventListener('click', setLast6MonthsSubtasks);
document.getElementById('btnLimparFiltrosSubtasks').addEventListener('click', clearFiltersSubtasks);

document.getElementById('pageSizeSubtasks').addEventListener('change', function() {
    pageSizeSubtasks = parseInt(this.value);
    currentPageSubtasks = 1;
    renderTableSubtasks();
});

document.getElementById('btnRefreshSubtasks').addEventListener('click', function() {
    document.getElementById('tableContainerSubtasks').style.display = 'none';
    document.getElementById('errorSubtasks').style.display = 'none';
    document.getElementById('loadingSubtasks').style.display = 'block';
    loadSubtasksData();
});

document.getElementById('btnExportCSVSubtasks').addEventListener('click', exportFilteredCSVSubtasks);

document.addEventListener('DOMContentLoaded', function() {
    initializeDefaultDatesSubtasks();
    loadSubtasksData();
});
</script>
{% endblock %}